window.__triliumChatVersion="0.4.5",(()=>{"use strict";var e,t,n,s,i={175:(e,t,n)=>{n.d(t,{Z:()=>o});var s=n(81),i=n.n(s),r=n(645),a=n.n(r)()(i());a.push([e.id,".chat-wrapper .chat_modal {\n  position: fixed;\n  z-index: 1000;\n  display: none;\n  inset: 0;\n}\n.chat-wrapper .chat_modal.show {\n  display: block;\n}\n.chat-wrapper .chat_modal .modal_mask {\n  position: absolute;\n  z-index: -1;\n  top: 0;\n  right: 0;\n  bottom: 0;\n  left: 0;\n  pointer-events: auto;\n  transition: all 0.3s;\n}\n.chat-wrapper .chat_modal .modal_mask.fadein {\n  background: rgba(0, 0, 0, 0.45);\n}\n.chat-wrapper .chat_modal .content_wrapper {\n  position: absolute;\n  z-index: 1000;\n  background: var(--main-background-color);\n  transition: all 0.3s;\n  will-change: transform, opacity;\n}\n.chat-wrapper .chat_modal .content_wrapper_popup {\n  bottom: 0;\n  width: 100%;\n  height: 70%;\n  border-radius: 8px 8px 0 0;\n  transform: translateY(100%);\n}\n.chat-wrapper .chat_modal .content_wrapper_popup.fadein {\n  transform: translateY(0);\n}\n.chat-wrapper .chat_modal .content_wrapper_dialog {\n  width: calc(100% - 40px);\n  border-radius: 8px;\n  opacity: 0;\n  transform: scale(0.1);\n}\n.chat-wrapper .chat_modal .content_wrapper_dialog.fadein {\n  top: 30% !important;\n  left: 20px !important;\n  opacity: 1;\n  transform: scale(1);\n}\n.chat-wrapper .chat_popover {\n  position: absolute;\n  opacity: 0;\n  will-change: transform, opacity, top, left, right, top;\n}\n.chat-wrapper .chat_popover .tooltip-text {\n  padding: 6px;\n  border: 1px solid var(--main-border-color);\n  background: var(--main-background-color);\n  border-radius: 4px;\n}\n.chat-wrapper .chat_popover.fadein {\n  opacity: 1;\n  transform: scale(1) !important;\n}\n.chat-wrapper .form_wrapper {\n  padding: 10px 16px;\n}\n.chat-wrapper .form_wrapper .wapper_title {\n  font-size: 120%;\n}\n.chat-wrapper .form_wrapper .wrapper_op {\n  margin-top: 3px;\n  text-align: right;\n}\n.chat-wrapper .form_wrapper .chat_button {\n  display: inline-block;\n  width: 70px;\n  border-color: var(--main-text-color);\n}\n.chat-wrapper .form_wrapper .wrapper_btn_save {\n  border: none;\n  background: var(--trilium-green);\n  color: var(--main-background-color);\n}\n.chat-wrapper .form_wrapper .wrapper_btn_save:hover {\n  opacity: 0.8;\n}\n.chat-wrapper .form_wrapper .wrapper_btn_cancel {\n  border: 1px solid var(--main-border-color);\n  color: var(--main-border-color);\n}\n.chat-wrapper .form_wrapper .wrapper_btn_cancel:hover {\n  border: 1px solid var(--trilium-green);\n  color: var(--trilium-green);\n}\n.chat-wrapper .thread {\n  position: relative;\n  height: calc(100% - 247px);\n  flex: 1;\n  border-bottom: 1px solid var(--main-border-color);\n  background: var(--left-pane-background-color);\n  transition: height 0.3s;\n}\n.chat-wrapper .thread .thread-messages {\n  display: flex;\n  height: 100%;\n  flex-direction: column;\n  padding: 10px;\n  padding-bottom: 50px;\n  overflow-y: auto;\n  scroll-behavior: smooth;\n}\n.chat-wrapper .thread .thread-messages .message {\n  position: relative;\n  display: flex;\n  max-width: 80%;\n  flex-direction: column;\n  padding: 8px 10px;\n  margin-bottom: 10px;\n  background-color: var(--main-background-color);\n}\n.chat-wrapper .thread .thread-messages .message .message-text {\n  white-space: pre-wrap;\n  word-wrap: break-word;\n  line-height: 1.2;\n  /* Standard line height for overall text */\n  /* Styles for code highlighting */\n}\n.chat-wrapper .thread .thread-messages .message .message-text h1 {\n  margin: 0;\n  /* Remove margins */\n  padding: 0;\n  /* Remove padding */\n  font-size: 2em;\n  /* Keep h1 size */\n  line-height: 1;\n  /* Reduced line height */\n}\n.chat-wrapper .thread .thread-messages .message .message-text h2 {\n  margin-top: 2px;\n  margin-bottom: 2px;\n  padding: 0;\n  line-height: 1.2;\n  /* Adjusted line height */\n}\n.chat-wrapper .thread .thread-messages .message .message-text h3 {\n  margin-top: 2px;\n  margin-bottom: 2px;\n  padding: 0;\n  line-height: 1.2;\n  /* Adjusted line height */\n}\n.chat-wrapper .thread .thread-messages .message .message-text h4 {\n  margin-top: 2px;\n  margin-bottom: 2px;\n  padding: 0;\n  line-height: 1.2;\n  /* Adjusted line height */\n}\n.chat-wrapper .thread .thread-messages .message .message-text h5 {\n  margin-top: 2px;\n  margin-bottom: 2px;\n  padding: 0;\n  line-height: 1.2;\n  /* Adjusted line height */\n}\n.chat-wrapper .thread .thread-messages .message .message-text h6 {\n  margin-top: 2px;\n  margin-bottom: 2px;\n  padding: 0;\n  line-height: 1.2;\n  /* Adjusted line height */\n}\n.chat-wrapper .thread .thread-messages .message .message-text ul,\n.chat-wrapper .thread .thread-messages .message .message-text ol {\n  margin-top: 2px;\n  margin-bottom: 2px;\n  line-height: 1.2;\n  /* Adjusted line height */\n}\n.chat-wrapper .thread .thread-messages .message .message-text li,\n.chat-wrapper .thread .thread-messages .message .message-text p {\n  margin-top: 2px;\n  margin-bottom: 2px;\n  padding: 0;\n  line-height: 1.2;\n  /* Adjusted line height */\n}\n.chat-wrapper .thread .thread-messages .message .message-text p + p {\n  margin-top: 0;\n  /* Ensure no extra space between paragraphs */\n}\n.chat-wrapper .thread .thread-messages .message .message-text pre {\n  background-color: var(--code-background-color);\n  border-radius: 5px;\n  padding: 10px;\n  overflow-x: auto;\n  /* Add horizontal scroll for long lines */\n  margin-bottom: 10px;\n  /* Add space below code block */\n}\n.chat-wrapper .thread .thread-messages .message .message-text code {\n  font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;\n  font-size: 0.9em;\n}\n.chat-wrapper .thread .thread-messages .message .message-text pre code {\n  display: block;\n  /* Ensure code block takes full width */\n  padding: 0;\n  /* Remove padding from code inside pre */\n  background-color: transparent;\n  /* Remove background from code inside pre */\n}\n.chat-wrapper .thread .thread-messages .message .dot {\n  position: absolute;\n  top: 50%;\n  right: -10px;\n  width: 20px;\n  height: 20px;\n  padding: 0;\n  background-color: var(--main-background-color);\n  box-shadow: 0 0 4px rgba(0, 0, 0, 0.2);\n  font-size: 1em;\n  line-height: 18px;\n  opacity: 0;\n  pointer-events: none;\n  text-align: center;\n  transform: translateY(-50%);\n  transition: opacity 0.1s;\n}\n.chat-wrapper .thread .thread-messages .message:hover .dot {\n  opacity: 1;\n  pointer-events: auto;\n}\n.chat-wrapper .thread .thread-messages .message .think-toggle-button {\n  background: none;\n  border: none;\n  color: var(--trilium-green);\n  cursor: pointer;\n  text-decoration: underline;\n  padding: 0;\n  font-size: 0.9em;\n  align-self: flex-start;\n  /* Align button to the left */\n}\n.chat-wrapper .thread .thread-messages .message .think-content {\n  padding: 10px;\n  margin-bottom: 10px;\n  /* Add space below thinking content */\n  border: 1px solid var(--main-border-color);\n  border-radius: 5px;\n  background-color: var(--left-pane-background-color);\n  white-space: pre-wrap;\n  word-wrap: break-word;\n}\n.chat-wrapper .thread .thread-messages .received {\n  align-self: flex-start;\n  border-radius: 2px 12px 12px;\n}\n.chat-wrapper .thread .thread-messages .sent {\n  align-self: flex-end;\n  border: 1px solid var(--trilium-green);\n  border-radius: 12px 2px 12px 12px;\n}\n.chat-wrapper .thread .thread-messages .sent .dot {\n  right: initial;\n  left: -10px;\n}\n.chat-wrapper .thread .thread_op {\n  position: absolute;\n  bottom: 10px;\n  left: 50%;\n  display: none;\n  padding: 4px 8px;\n  border: 1px solid var(--button-border-color);\n  background: var(--main-background-color);\n  border-radius: 8px;\n  color: var(--main-text-color);\n  transform: translateX(-50%);\n  transition: all 0.3s;\n  white-space: nowrap;\n}\n.chat-wrapper .thread .thread_op:hover {\n  border-color: var(--trilium-green);\n}\n.chat-wrapper .thread .thread_op.show {\n  display: block;\n}\n.chat-wrapper .operate {\n  display: flex;\n  height: 210px;\n  flex-direction: column;\n  padding: 0 16px;\n}\n.chat-wrapper .operate .operate_top {\n  height: 44px;\n}\n.chat-wrapper .operate .operate_top .operate_btn {\n  margin-right: 2px;\n  color: var(--main-text-color);\n}\n.chat-wrapper .operate .operate_top .operate_btn_new:hover {\n  border-color: var(--trilium-green);\n  color: var(--trilium-green) !important;\n}\n.chat-wrapper .operate .operate_input {\n  position: relative;\n  flex: 1;\n}\n.chat-wrapper .operate .operate_input .input-area {\n  width: 100%;\n  height: 100%;\n  padding: 6px 8px;\n  background-color: var(--main-background-color) !important;\n  border-radius: 8px;\n  outline: none;\n  resize: none;\n  transition: border 0.2s;\n  /*  &::placeholder {\n                color: #ddd;\n            } */\n}\n.chat-wrapper .operate .operate_input .input-area:focus {\n  border: 1px solid var(--trilium-green);\n}\n.chat-wrapper .operate .operate_input .operate_send {\n  position: absolute;\n  right: 6px;\n  bottom: 6px;\n  color: var(--trilium-green);\n}\n.chat-wrapper .operate .operate_input .operate_send.freezed {\n  color: var(--main-border-color);\n}\n.chat-wrapper .operate .operate_bottom {\n  height: 30px;\n  font-size: 13px;\n}\n.chat-wrapper .content_select {\n  display: flex;\n  height: 100%;\n  flex-direction: column;\n  user-select: none;\n}\n.chat-wrapper .content_select .select_top {\n  height: 44px;\n  padding-right: 4px;\n  padding-left: 16px;\n  border-bottom: 1px solid var(--main-border-color);\n}\n.chat-wrapper .content_select .select_search {\n  height: 40px;\n  padding: 0 10px;\n  margin: 10px 16px;\n  border-radius: 8px;\n}\n.chat-wrapper .content_select .bx-search {\n  font-size: 120%;\n}\n.chat-wrapper .content_select .select_search_input {\n  flex: 1;\n  margin-left: 4px;\n}\n.chat-wrapper .content_select .select_list {\n  flex: 1;\n  padding: 0 16px;\n  padding-bottom: 20px;\n  overflow-y: auto;\n}\n.chat-wrapper .content_select .select_item {\n  position: relative;\n  padding: 8px;\n  border-radius: 8px;\n  color: var(--inactive-tab-text-color);\n  cursor: pointer;\n  font-size: 90%;\n}\n.chat-wrapper .content_select .select_item::after {\n  position: absolute;\n  bottom: 0;\n  width: calc(100% - 16px);\n  border-bottom: 1px solid var(--left-pane-background-color);\n  content: '';\n}\n.chat-wrapper .content_select .select_item:hover,\n.chat-wrapper .content_select .select_item:focus {\n  background: var(--left-pane-background-color);\n}\n.chat-wrapper .content_select .select_item .favor {\n  position: absolute;\n  top: 2px;\n  right: 8px;\n  border: 8px solid transparent;\n  border-top-color: var(--trilium-green);\n}\n.chat-wrapper .content_select .select_item .item_title {\n  color: var(--main-text-color);\n  font-weight: 700;\n}\n.chat-wrapper .content_select .select_item .item_stamp {\n  font-size: 80%;\n}\n.chat-wrapper .content_select .select_item .item_top,\n.chat-wrapper .content_select .select_item .item_down {\n  position: relative;\n}\n.chat-wrapper .content_select .select_item .item_op {\n  position: absolute;\n  top: 50%;\n  right: 0;\n  display: none;\n  height: 24px;\n  transform: translateY(-50%);\n}\n.chat-wrapper .content_select .select_item .item_op .icon-action {\n  width: 24px;\n  height: 24px;\n  padding: 0;\n}\n.chat-wrapper .content_select .select_item:hover .item_preview {\n  padding-right: 30px;\n}\n.chat-wrapper .content_select .select_item:hover .item_op {\n  display: block;\n}\n.chat-wrapper .popover_prompt {\n  width: 100%;\n  height: 300px;\n  min-height: 300px;\n  background: var(--main-background-color);\n  box-shadow: 0 0 4px rgba(0, 0, 0, 0.2);\n}\n.chat-wrapper .content_select_prompt .item_title {\n  padding-right: 60px;\n}\n.chat-wrapper {\n  position: fixed;\n  z-index: 1000;\n  top: 40px;\n  right: 0;\n  display: flex;\n  overflow: hidden;\n  width: 420px;\n  min-width: 420px;\n  max-width: calc(100% - 40px);\n  height: calc(100% - 40px);\n  flex-direction: column;\n  border-right: none;\n  border-bottom: none;\n  background: var(--main-background-color);\n  border-radius: 8px 0 0 8px;\n  box-shadow: 0 4px 4px rgba(0, 0, 0, 0.1);\n  transform: translate3d(120%, 0, 0);\n  transition: transform 0.3s;\n  visibility: visible !important;\n  will-change: width;\n  --trilium-green: #50a52c;\n}\n.chat-wrapper .bd-main,\n.chat-wrapper {\n  border: 1px solid var(--main-border-color);\n}\n.chat-wrapper *::-webkit-scrollbar {\n  width: 6px;\n}\n.chat-wrapper input {\n  border: none;\n  outline: none;\n}\n.chat-wrapper * {\n  box-sizing: border-box;\n}\n.chat-wrapper.show {\n  transform: translateZ(0);\n}\n.chat-wrapper .flex-center {\n  display: flex;\n  align-items: center;\n}\n.chat-wrapper .flex-center-between {\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n}\n.chat-wrapper .flex-row-reverse {\n  display: flex;\n  flex-direction: row-reverse;\n  align-items: center;\n}\n.chat-wrapper .no-shrink {\n  flex-shrink: 0;\n}\n.chat-wrapper .one-line {\n  overflow: hidden;\n  text-overflow: ellipsis;\n  white-space: nowrap;\n}\n.chat-wrapper .link,\n.chat-wrapper .link:visited,\n.chat-wrapper .link:hover {\n  color: inherit;\n  text-decoration: none;\n}\n.chat-wrapper .icon-view {\n  font-size: 180%;\n}\n.chat-wrapper .icon-action {\n  width: 36px;\n  height: 36px;\n}\n.chat-wrapper .chat_button {\n  padding: 5px 8px;\n  border: 1px solid var(--button-border-color);\n  background: var(--button-background-color);\n  border-radius: 8px;\n  color: var(--main-text-color);\n  cursor: pointer;\n  text-align: center;\n  transition: all 0.2s;\n  user-select: none;\n}\n.chat-wrapper .chat_button:hover {\n  text-decoration: none;\n}\n.chat-wrapper .chat_button:disabled {\n  cursor: not-allowed;\n}\n.chat-wrapper .resizer {\n  position: absolute;\n  z-index: 1;\n  left: 0;\n  width: 8px;\n  height: 100%;\n  cursor: e-resize;\n}\n.chat-wrapper .header {\n  display: flex;\n  height: 37px;\n  align-items: center;\n  justify-content: space-between;\n  padding-left: 10px;\n  border-bottom: 1px solid var(--main-border-color);\n}\n.chat-wrapper .header .dot {\n  position: relative;\n}\n.chat-wrapper .header .dot::after {\n  position: absolute;\n  top: 0;\n  right: 0;\n  width: 6px;\n  height: 6px;\n  background: #e37a28;\n  border-radius: 3px;\n  content: '';\n}\n.chat-wrapper .header .header_hide {\n  border-radius: 0;\n}\n.chat-wrapper .header .header_hide:hover {\n  border: 1px solid transparent;\n  background: var(--left-pane-background-color);\n}\n.chat-wrapper .prompt_content {\n  overflow: hidden;\n  height: 0;\n  flex-shrink: 0;\n  background: var(--main-background-color);\n  transition: height 0.3s;\n}\n.chat-wrapper .prompt_content.show {\n  max-height: 200px;\n  border-bottom: 1px solid var(--main-border-color);\n}\n.chat-wrapper .prompt_content .prompt_content_close {\n  height: 40px;\n  padding-right: 4px;\n  border-bottom: 1px solid var(--main-border-color);\n}\n.chat-wrapper .prompt_content .prompt_content_text {\n  max-height: 160px;\n  padding: 10px;\n  overflow-y: auto;\n}\n.chat-wrapper .content_command,\n.chat-wrapper .msg-command {\n  overflow: hidden;\n  background: var(--main-background-color);\n  border-radius: 8px;\n  box-shadow: 0 0 4px rgba(0, 0, 0, 0.2);\n  user-select: none;\n}\n.chat-wrapper .content_command .command_title,\n.chat-wrapper .msg-command .command_title {\n  padding-left: 10px;\n  border-bottom: 1px solid var(--main-border-color);\n  line-height: 36px;\n}\n.chat-wrapper .content_command .command_item,\n.chat-wrapper .msg-command .command_item {\n  padding: 4px 8px;\n  cursor: pointer;\n}\n.chat-wrapper .content_command .command_item:hover,\n.chat-wrapper .msg-command .command_item:hover,\n.chat-wrapper .content_command .command_item:focus,\n.chat-wrapper .msg-command .command_item:focus {\n  background: var(--left-pane-background-color);\n}\n.chat-wrapper .content_prompt_form label {\n  display: block;\n}\n.chat-wrapper .content_prompt_form .prompt_input {\n  width: 100%;\n  padding-left: 8px;\n  border-radius: 8px;\n  line-height: 30px;\n  transition: all 0.3s;\n}\n.chat-wrapper .content_prompt_form .prompt_input:focus {\n  border-color: var(--trilium-green);\n}\n.chat-wrapper .content_prompt_form .prompt_input_content {\n  min-height: 170px;\n  outline: none;\n  resize: none;\n}\n",""]);const o=a},447:(e,t,n)=>{n.d(t,{Z:()=>o});var s=n(81),i=n.n(s),r=n(645),a=n.n(r)()(i());a.push([e.id,".chat-toggle-wrapper {\n  display: flex;\n  height: 100%;\n}\n.chat-toggle-wrapper .button-widget {\n  font-size: 1.5em !important;\n  line-height: 1 !important;\n}\n",""]);const o=a},645:e=>{e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var n="",s=void 0!==t[5];return t[4]&&(n+="@supports (".concat(t[4],") {")),t[2]&&(n+="@media ".concat(t[2]," {")),s&&(n+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),n+=e(t),s&&(n+="}"),t[2]&&(n+="}"),t[4]&&(n+="}"),n})).join("")},t.i=function(e,n,s,i,r){"string"==typeof e&&(e=[[null,e,void 0]]);var a={};if(s)for(var o=0;o<this.length;o++){var c=this[o][0];null!=c&&(a[c]=!0)}for(var l=0;l<e.length;l++){var h=[].concat(e[l]);s&&a[h[0]]||(void 0!==r&&(void 0===h[5]||(h[1]="@layer".concat(h[5].length>0?" ".concat(h[5]):""," {").concat(h[1],"}")),h[5]=r),n&&(h[2]?(h[1]="@media ".concat(h[2]," {").concat(h[1],"}"),h[2]=n):h[2]=n),i&&(h[4]?(h[1]="@supports (".concat(h[4],") {").concat(h[1],"}"),h[4]=i):h[4]="".concat(i)),t.push(h))}},t}},81:e=>{e.exports=function(e){return e[1]}},379:e=>{var t=[];function n(e){for(var n=-1,s=0;s<t.length;s++)if(t[s].identifier===e){n=s;break}return n}function s(e,s){for(var r={},a=[],o=0;o<e.length;o++){var c=e[o],l=s.base?c[0]+s.base:c[0],h=r[l]||0,p="".concat(l," ").concat(h);r[l]=h+1;var d=n(p),u={css:c[1],media:c[2],sourceMap:c[3],supports:c[4],layer:c[5]};if(-1!==d)t[d].references++,t[d].updater(u);else{var g=i(u,s);s.byIndex=o,t.splice(o,0,{identifier:p,updater:g,references:1})}a.push(p)}return a}function i(e,t){var n=t.domAPI(t);return n.update(e),function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap&&t.supports===e.supports&&t.layer===e.layer)return;n.update(e=t)}else n.remove()}}e.exports=function(e,i){var r=s(e=e||[],i=i||{});return function(e){e=e||[];for(var a=0;a<r.length;a++){var o=n(r[a]);t[o].references--}for(var c=s(e,i),l=0;l<r.length;l++){var h=n(r[l]);0===t[h].references&&(t[h].updater(),t.splice(h,1))}r=c}}},569:e=>{var t={};e.exports=function(e,n){var s=function(e){if(void 0===t[e]){var n=document.querySelector(e);if(window.HTMLIFrameElement&&n instanceof window.HTMLIFrameElement)try{n=n.contentDocument.head}catch(e){n=null}t[e]=n}return t[e]}(e);if(!s)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");s.appendChild(n)}},216:e=>{e.exports=function(e){var t=document.createElement("style");return e.setAttributes(t,e.attributes),e.insert(t,e.options),t}},565:(e,t,n)=>{e.exports=function(e){var t=n.nc;t&&e.setAttribute("nonce",t)}},795:e=>{e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var t=e.insertStyleElement(e);return{update:function(n){!function(e,t,n){var s="";n.supports&&(s+="@supports (".concat(n.supports,") {")),n.media&&(s+="@media ".concat(n.media," {"));var i=void 0!==n.layer;i&&(s+="@layer".concat(n.layer.length>0?" ".concat(n.layer):""," {")),s+=n.css,i&&(s+="}"),n.media&&(s+="}"),n.supports&&(s+="}");var r=n.sourceMap;r&&"undefined"!=typeof btoa&&(s+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(r))))," */")),t.styleTagTransform(s,e,t.options)}(t,e,n)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(t)}}}},589:e=>{e.exports=function(e,t){if(t.styleSheet)t.styleSheet.cssText=e;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(e))}}},605:(e,t,n)=>{n.d(t,{Z:()=>s});class s{constructor(){this.listeners={}}addEventListener(e,t){this.listeners[e]||(this.listeners[e]=[]),-1===this.listeners[e].indexOf(t)&&this.listeners[e].push(t)}on(e,t){Array.isArray(e)?e.forEach((e=>{this.addEventListener(e,t)})):this.addEventListener(e,t)}removeEventListener(e,t){if(!this.listeners[e])return;const n=[];for(let s=0;s<this.listeners[e].length;s+=1)this.listeners[e][s]!==t&&n.push(this.listeners[e][s]);0===this.listeners[e].length?delete this.listeners[e]:this.listeners[e]=n}off(e,t){return this.removeEventListener(e,t)}dispatchEvent(e){if(!e)return!0;e.source=this;const t=`on${e.type}`;return(!Object.hasOwnProperty.call(this,t)||(this[t].call(this,e),!e.defaultPrevented))&&(!this.listeners[e.type]||this.listeners[e.type].every((t=>(t(e),!e.defaultPrevented))))}emit(e,...t){this.listeners[e]&&this.listeners[e].forEach((e=>{e(...t)}))}}},471:(e,t,n)=>{n.d(t,{Z:()=>a});var s=n(257),i=n(655),r=n(605);class a extends r.Z{async initOptions(){const e=await this.getOptions();if(!e)return this.setDefaultOptions();if(!(0,i.tY)(s.WN,e))return e;const t=(0,i.Yo)(e,s.WN);return this.setOptions(t)}async initPrompts(){if(!await this.getPrompts())return this.setDefaultPrompts()}async getOptions(){(0,i.de)()}async setOption(e,t){this.emit(s.bs.setStatus,{status:s.f5.optionSyncing,key:e,value:t});const n=await this.getOptions();n[e]=t,await this.setOptions(n),this.emit(s.bs.setStatus,{status:s.f5.success,key:e,value:t})}async setOptions(){(0,i.de)()}async setDefaultOptions(){(0,i.de)()}async getOption(e){return(await this.getOptions())[e]}async getPrompts(){(0,i.de)()}async setPrompts(){(0,i.de)()}async setDefaultPrompts(){(0,i.de)()}async createPrompt(e){const t=await this.getPrompts(),n={...e,order:t.length};t.push(n),await this.setPrompts(t)}async updatePrompt(e,t){const n=await this.getPrompts(),s=n.findIndex((t=>t.id===e.id));if(-1===s)throw new Error("can't find target prompt");t?n.splice(s,1):n.splice(s,1,e),await this.setPrompts(n)}async deletePrompt(e){await this.updatePrompt(e,!0)}getActiveNoteContent(){(0,i.de)()}async getClip(){try{return await navigator.clipboard.readText()}catch(e){return s.O2}}async handleCommand(e,t){(0,i.fF)(e,t);const n={copy:this.handleCopy.bind(this),favor:this.handleFavor.bind(this),unfavor:this.handleUnfavor.bind(this),set:this.handleSetNote.bind(this),append:this.handleAppend.bind(this),child:this.handleSaveChild.bind(this),history:this.handleSaveHistory.bind(this)};n[e]&&await n[e](t)}handleCopy(e){const t=(0,i.qT)(e.thread);(0,i.JG)(t)}async handleFavor(e){await this.toggleFavor(e,!0)}async handleUnfavor(e){await this.toggleFavor(e,!1)}async toggleFavor(e,t){const n=await this.getRecord(e.threadId);n||(0,i._y)(s.t$),n.favor=t,await this.saveRecord(n)}async handleSetNote(e){await this.setNoteWith(e.thread)}setNoteWith(){(0,i.de)()}async handleAppend(e){await this.appendToNote(e.thread)}appendToNote(){(0,i.de)()}async handleSaveChild(e){const t=(0,i.qT)(e.thread,!0),n=(0,i.$k)(e);await this.saveToChild(n,t)}saveToChild(){(0,i.de)()}async handleMsgCommand(e,t,n){(0,i.fF)(e,t);const s={copy:this.msgCopy.bind(this),insert:this.insertContent.bind(this),append:this.msgAppend.bind(this),set:this.msgSet.bind(this),child:this.msgChild.bind(this)};s[e]&&await s[e](t,n)}msgCopy(e){(0,i.fF)(e),(0,i.JG)(e)}insertContent(){(0,i.de)()}async msgAppend(e){await this.appendToNote(e)}async msgSet(e){await this.setNoteWith(e,!0)}async msgChild(e,t){const n=(0,i.$k)(t);await this.saveToChild(n,(0,i.IO)(e))}async handleSaveHistory(e){await this.saveRecordFromEngine(e)}async getRecords(){(0,i.de)()}async saveRecord(){(0,i.de)()}async handleMsgStatus(e,t){if(!t.thread.length)return;const n=(0,i.qr)(e),r=t.lastMessage.role===s.HB.assistant;n&&r&&this.saveRecordFromEngine(t)}async saveRecordFromEngine(e){const t=(0,i.Xg)((0,i.$k)(e)),n={id:e.threadId,originTitle:t,list:e.thread.map((e=>{const t={...e};return delete t.status,t}))};await this.saveRecord(n)}goHistorys(){(0,i.de)()}goHistory(){(0,i.de)()}goOptions(){(0,i.de)()}}},300:(e,t,n)=>{n(655),n(257),n(471)},0:(e,t,n)=>{n.d(t,{Z:()=>p});var s=n(257),i=n(655),r=n(471);const a=["text","code"];function o(){const e=api.getActiveContextNote();return e||(0,i._y)("no active note"),a.includes(e.type)||(0,i._y)(s.GD),e}function c(e,t,n){e=t?(0,i.qT)(e,!0):(0,i.RV)(e);const s=n.data.processor.toView(e);return n.data.toModel(s)}async function l(e){const t=Array.isArray(e),n=o();await glob.appContext.initialized;const s=glob.appContext.tabManager.children.find((e=>e.noteId===n.noteId));let r;if(await s.isReadOnly()&&(0,i._y)("note is readOnly"),"text"===n.type)return r=await api.getActiveContextTextEditor(),{insert(){r.model.change((t=>{const n=r.model.document.selection.getLastPosition();t.insertText(e,n)}))},set(){const n=r.model.createRangeIn(r.model.document.getRoot());r.model.insertContent(c(e,t,r),n)},append(){r.model.change((n=>{n.append(c(e,t,r),r.model.document.getRoot())}))}};if("code"===n.type){r=await api.getActiveContextCodeEditor();const n=r.getDoc();return{insert(){const t=n.getCursor();n.replaceRange(e,t)},set(){t&&(e=(0,i.qT)(e)),n.setValue(e)},append(){r.replaceRange(e,{line:1/0})}}}}async function h(e){const t=/<section\s+class="include-note"\s+data-note-id="([\w-]+)"[^>]+>.*<\/section>/gi;let n;for(;null!==(n=t.exec(e));){const t=n[1],{title:s}=await api.getNote(t);e=e.replace(n[0],`<a class="reference-link" data-note-path="${t}"<span class="bx bx-note"></span>${s}</a>`)}return e}class p extends r.Z{async getOptions(){return api.runOnBackend((e=>{const t=api.getNoteWithLabel(e);if(!t)return null;return t.getJsonContent()||null}),[s.cT.CHAT_OPTIONS])}async setOptions(e){return await api.runOnBackend(((e,t)=>{const n=JSON.stringify(t,null,"\t"),s=api.getNoteWithLabel(e);return s?s.setContent(n):api.createNewNote({parentNoteId:api.currentNote.noteId,title:"CHAT_OPTIONS: reload to take effect",content:n,type:"code",mime:"application/json"}).note.setLabel(e),s}),[s.cT.CHAT_OPTIONS,e])||this.goOptions(),{...e}}async setDefaultOptions(){return this.setOptions(s.WN)}async getPrompts(){return api.runOnBackend((e=>{const t=api.getNoteWithLabel(e);if(!t)return null;return t.getJsonContent()||null}),[s.cT.CHAT_PROMPTS])}async setPrompts(e){return await api.runOnBackend(((e,t)=>{const n=JSON.stringify(t,null,"\t"),s=api.getNoteWithLabel(e);s?s.setContent(n):api.createNewNote({parentNoteId:api.currentNote.noteId,title:"CHAT_PROMPTS",content:n,type:"code",mime:"application/json"}).note.setLabel(e)}),[s.cT.CHAT_PROMPTS,e]),{...e}}async setDefaultPrompts(){return this.setPrompts(s.HT)}async getActiveNoteContent(){try{const e=o(),{content:t}=await e.getNoteComplement();return{engine:t,view:"text"===e.type?await h(t):(0,i.YU)(t)}}catch(e){this.emit(s.bs.setStatus,{status:s.f5.failed,key:"activeNote",value:e.message}),(0,i._y)(e.message)}}async getRecords(){return api.runOnBackend((e=>(api.getNotesWithLabel(e)||[]).map((e=>({...e.getJsonContent(),title:e.title})))),[s.cT.HISTORY_LABEL])}async getRecord(e){return api.runOnBackend(((e,t)=>{const n=api.getNoteWithLabel(e,t);return n?{...n.getJsonContent(),title:n.title}:null}),[s.cT.HISTORY_LABEL,e])}async saveRecord(e){return await api.runOnBackend(((e,t,n)=>{const s=api.getNoteWithLabel(t,`${n.id}`),i=JSON.stringify(n,null,"\t");if(s)s.setContent(i);else{const s=api.getNoteWithLabel(e)||api.currentNote;api.createNewNote({parentNoteId:s.noteId,title:n.originTitle,content:i,type:"code",mime:"application/json"}).note.setLabel(t,n.id)}}),[s.cT.HISTORY_HOME_LABEL,s.cT.HISTORY_LABEL,e]),{...e}}async goHistorys(){const e=await api.runOnBackend((e=>api.getNoteWithLabel(e)||api.currentNote),[s.cT.HISTORY_HOME_LABEL]);api.activateNote(e.noteId)}async goHistory(e){const t=await api.runOnBackend(((e,t)=>api.getNoteWithLabel(e,t)),[s.cT.HISTORY_LABEL,e]);api.activateNote(t.noteId)}async setNoteWith(e){(await l(e)).set()}async appendToNote(e){(await l(e)).append()}async saveToChild(e,t){const n=api.getActiveContextNote();await api.runOnBackend(((e,t,n)=>api.createNewNote({parentNoteId:e,title:t,content:n,type:"text"}).note),[n.noteId,e,t])}async insertContent(e){(await l(e)).insert()}async goOptions(){const e=await api.runOnBackend((e=>api.getNoteWithLabel(e)),[s.cT.CHAT_OPTIONS]);api.activateNote(e.noteId)}}},926:(e,t,n)=>{n.d(t,{Z:()=>c});var s=n(257),i=n(655),r=n(605);class a extends r.Z{constructor(e,t={}){super(),this.url=e,this.method=t.method||"GET",this.headers=t.headers||{},this.payload=t.payload||null,this.withCredentials=t.withCredentials||!1,this.readyState=this.CONNECTING,this.progress=0,this.chunk="",this.xhr=null,this.FIELD_SEPARATOR=":",this.INITIALIZING=-1,this.CONNECTING=0,this.OPEN=1,this.CLOSED=2}_setReadyState(e){const t=new CustomEvent("readyStateChange");t.readyState=e,this.readyState=e,this.dispatchEvent(t)}_onStreamFailure(e){const t=new CustomEvent("error");t.data=e.currentTarget.response,this.dispatchEvent(t),this.close()}_onStreamAbort(){this.close()}_onStreamProgress(e){if(!this.xhr)return;if(200!==this.xhr.status)return void this._onStreamFailure(e);this.readyState===this.CONNECTING&&(this.dispatchEvent(new CustomEvent("open")),this._setReadyState(this.OPEN));const t=this.xhr.responseText.substring(this.progress);this.progress+=t.length,t.split(/(\r\n|\r|\n){2}/g).forEach((e=>{0===e.trim().length?(this.dispatchEvent(this._parseEventChunk(this.chunk.trim())),this.chunk=""):this.chunk+=e}))}_onStreamLoaded(e){this._onStreamProgress(e),this.dispatchEvent(this._parseEventChunk(this.chunk)),this.chunk=""}_parseEventChunk(e){if(!e||0===e.length)return null;const t={id:null,retry:null,data:"",event:"message"};e.split(/(\r\n|\r|\n)/).forEach((e=>{const n=e.trimRight(),s=n.indexOf(this.FIELD_SEPARATOR);if(s<=0)return;const i=n.substring(0,s);if(!(i in t))return;const r=n.substring(s+1).trimLeft();"data"===i?t[i]+=r:t[i]=r}));const n=new CustomEvent(t.event);return n.data=t.data,n.id=t.id,n}_checkStreamClosed(){this.xhr&&this.xhr.readyState===XMLHttpRequest.DONE&&this._setReadyState(this.CLOSED)}stream(){this._setReadyState(this.CONNECTING),this.xhr=new XMLHttpRequest,this.xhr.addEventListener("progress",this._onStreamProgress.bind(this)),this.xhr.addEventListener("load",this._onStreamLoaded.bind(this)),this.xhr.addEventListener("readystatechange",this._checkStreamClosed.bind(this)),this.xhr.addEventListener("error",this._onStreamFailure.bind(this)),this.xhr.addEventListener("abort",this._onStreamAbort.bind(this)),this.xhr.open(this.method,this.url),Object.keys(this.headers).forEach((e=>{this.xhr.setRequestHeader(e,this.headers[e])})),this.xhr.withCredentials=this.withCredentials,this.xhr.send(this.payload)}close(){this.readyState!==this.CLOSED&&(this.xhr.abort(),this.xhr=null,this._setReadyState(this.CLOSED))}}const o="...";class c extends r.Z{constructor({apiKey:e,engineOptions:t,systemPrompt:n,requestUrls:s}){super(),this.urls=s,this.apiKey=e,this.defaultOptions=t,this.systemPrompt=n}get lastMessage(){return this.thread.length?this.thread[this.thread.length-1]:null}set lastMessage(e){if(!this.thread[this.thread.length-1])throw new Error("lastMessage not exist");this.thread[this.thread.length-1]=e}newChat(){const e=[];this.systemPrompt&&e.push({role:s.HB.system,content:this.systemPrompt,status:s.S2.success}),this.loadThread({id:Date.now().toString(),list:e}),this.emit(s.TH.setStatus,s.S2.none)}loadThread(e){this.endStream(),this.threadId=e.id,this.thread=e.list.map((e=>({...e,status:s.S2.success}))),this.emit(s.TH.load,this.thread)}isAvailable(){return!this.lastMessage||(0,i.qr)(this.lastMessage.status)}setLastMessageStatus(e){this.lastMessage.status!==e&&(this.lastMessage.status=e,(0,i.qr)(e)&&(this.lastMessage.stamp=Date.now()),this.emit(s.TH.setStatus,e))}createMessage(e,t=s.HB.user){const n={role:t,content:e,stamp:Date.now()};this.thread.push(n);const i=t===s.HB.user?s.S2.success:s.S2.fetching;this.setLastMessageStatus(i),this.emit(s.TH.create,{...this.lastMessage})}replaceMessage(e,t,n){if(!e)throw new Error("content required");this.lastMessage.content=e,this.lastMessage.role=n||this.lastMessage.role,this.setLastMessageStatus(t||this.lastMessage.status),this.emit(s.TH.replace,{...this.lastMessage})}appendMessageWords(e){this.lastMessage&&(this.lastMessage.content+=e,this.emit(s.TH.append,{word:e,...this.lastMessage}))}requestCompletion({userInput:e,overrideOptions:t={}}){const n="string"==typeof e&&""===e.trim();if(e&&!n)return this.createMessage(e),this.createMessage(o,s.HB.assistant),this.sendRequest(t)}async sendRequest(e={}){const t={messages:this.thread.reduce(((e,t)=>((0,i.qr)(t.status)&&e.push({role:t.role,content:t.content}),e)),[]),...this.defaultOptions,...e};if(this.apiKey)try{t.stream?await this.requestChatStream(t):await this.requestChatBatch(t)}catch(e){e.data?this.replaceMessage(`The API returned the following error:\n ${e.data}`,s.S2.failed,s.HB.error):(console.error(e),this.replaceMessage("API Error. See console logs for details. (ctrl + shift + i)",s.S2.failed,s.HB.error))}else this.replaceMessage('Please verify your API Key is correct in the note titled "CHAT_OPTIONS", and then reload via (F5) or (Ctrl + R), or use the Trilium menu: Advanced > Reload Frontend',s.S2.failed,s.HB.error)}regenerate(e){if(this.lastMessage.role===s.HB.user)throw new Error("error detected!");this.replaceMessage(o,s.S2.fetching,s.HB.assistant),this.sendRequest(e)}async requestChatStream(e){await new Promise(((t,n)=>{try{this.activeStream=new a(this.urls.completion,{headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`},method:"POST",payload:JSON.stringify(e)});let r="";this.activeStream.addEventListener("message",(e=>{if((0,i.fF)(e.data),"[DONE]"!==e.data){const n=JSON.parse(e.data);if("stop"===n?.choices[0]?.finish_reason)this.endStream(),this.setLastMessageStatus(s.S2.success),t(r);else{const e=n.choices[0].delta.content;if(!e)return;r+=e,this.lastMessage.content===o?this.replaceMessage(e,s.S2.generating):this.appendMessageWords(e)}}else this.endStream(),this.setLastMessageStatus(s.S2.success),t(r)})),this.activeStream.addEventListener("readystatechange",(e=>{(0,i.fF)(e),e.readyState>=2&&(0,i.fF)(`ReadyState: ${e.readyState}`)})),this.activeStream.addEventListener("error",(e=>{this.endStream(),n(e)})),this.emit("beforeStream",{role:s.HB.assistant}),this.activeStream.stream()}catch(e){this.endStream(),n(e)}}))}cancelGenerating(){this.setLastMessageStatus(s.S2.cancel),this.emit(s.TH.cancel,{...this.lastMessage}),this.endStream()}endStream(){this.activeStream&&(this.activeStream.close(),this.activeStream=null)}async requestChatBatch(e){const t=await this.requestCompletionBatch(e);this.replaceMessage(t,s.S2.success)}async requestCompletionBatch(e){const t=await fetch(this.urls.completion,{method:"POST",mode:"cors",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify(e)}),n=await t.json(),{content:s}=n.choices?n.choices[0].message:n.message;return s}}},977:(e,t,n)=>{n.d(t,{Z:()=>Ue});var s=n(379),i=n.n(s),r=n(795),a=n.n(r),o=n(569),c=n.n(o),l=n(565),h=n.n(l),p=n(216),d=n.n(p),u=n(589),g=n.n(u),m=n(175),f={};f.styleTagTransform=g(),f.setAttributes=h(),f.insert=c().bind(null,"head"),f.domAPI=a(),f.insertStyleElement=d(),i()(m.Z,f),m.Z&&m.Z.locals&&m.Z.locals;var w=n(605),b=n(257),x=n(655);let k={async:!1,breaks:!1,extensions:null,gfm:!0,hooks:null,pedantic:!1,renderer:null,silent:!1,tokenizer:null,walkTokens:null};function v(e){k=e}const y={exec:()=>null};function $(e,t=""){let n="string"==typeof e?e:e.source;const s={replace:(e,t)=>{let i="string"==typeof t?t:t.source;return i=i.replace(_.caret,"$1"),n=n.replace(e,i),s},getRegex:()=>new RegExp(n,t)};return s}const _={codeRemoveIndent:/^(?: {1,4}| {0,3}\t)/gm,outputLinkReplace:/\\([\[\]])/g,indentCodeCompensation:/^(\s+)(?:```)/,beginningSpace:/^\s+/,endingHash:/#$/,startingSpaceChar:/^ /,endingSpaceChar:/ $/,nonSpaceChar:/[^ ]/,newLineCharGlobal:/\n/g,tabCharGlobal:/\t/g,multipleSpaceGlobal:/\s+/g,blankLine:/^[ \t]*$/,doubleBlankLine:/\n[ \t]*\n[ \t]*$/,blockquoteStart:/^ {0,3}>/,blockquoteSetextReplace:/\n {0,3}((?:=+|-+) *)(?=\n|$)/g,blockquoteSetextReplace2:/^ {0,3}>[ \t]?/gm,listReplaceTabs:/^\t+/,listReplaceNesting:/^ {1,4}(?=( {4})*[^ ])/g,listIsTask:/^\[[ xX]\] /,listReplaceTask:/^\[[ xX]\] +/,anyLine:/\n.*\n/,hrefBrackets:/^<(.*)>$/,tableDelimiter:/[:|]/,tableAlignChars:/^\||\| *$/g,tableRowBlankLine:/\n[ \t]*$/,tableAlignRight:/^ *-+: *$/,tableAlignCenter:/^ *:-+: *$/,tableAlignLeft:/^ *:-+ *$/,startATag:/^<a /i,endATag:/^<\/a>/i,startPreScriptTag:/^<(pre|code|kbd|script)(\s|>)/i,endPreScriptTag:/^<\/(pre|code|kbd|script)(\s|>)/i,startAngleBracket:/^</,endAngleBracket:/>$/,pedanticHrefTitle:/^([^'"]*[^\s])\s+(['"])(.*)\2/,unicodeAlphaNumeric:/[\p{L}\p{N}]/u,escapeTest:/[&<>"']/,escapeReplace:/[&<>"']/g,escapeTestNoEncode:/[<>"']|&(?!(#\d{1,7}|#[Xx][a-fA-F0-9]{1,6}|\w+);)/,escapeReplaceNoEncode:/[<>"']|&(?!(#\d{1,7}|#[Xx][a-fA-F0-9]{1,6}|\w+);)/g,unescapeTest:/&(#(?:\d+)|(?:#x[0-9A-Fa-f]+)|(?:\w+));?/gi,caret:/(^|[^\[])\^/g,percentDecode:/%25/g,findPipe:/\|/g,splitPipe:/ \|/,slashPipe:/\\\|/g,carriageReturn:/\r\n|\r/g,spaceLine:/^ +$/gm,notSpaceStart:/^\S*/,endingNewline:/\n$/,listItemRegex:e=>new RegExp(`^( {0,3}${e})((?:[\t ][^\\n]*)?(?:\\n|$))`),nextBulletRegex:e=>new RegExp(`^ {0,${Math.min(3,e-1)}}(?:[*+-]|\\d{1,9}[.)])((?:[ \t][^\\n]*)?(?:\\n|$))`),hrRegex:e=>new RegExp(`^ {0,${Math.min(3,e-1)}}((?:- *){3,}|(?:_ *){3,}|(?:\\* *){3,})(?:\\n+|$)`),fencesBeginRegex:e=>new RegExp(`^ {0,${Math.min(3,e-1)}}(?:\`\`\`|~~~)`),headingBeginRegex:e=>new RegExp(`^ {0,${Math.min(3,e-1)}}#`),htmlBeginRegex:e=>new RegExp(`^ {0,${Math.min(3,e-1)}}<(?:[a-z].*>|!--)`,"i")},S=/^ {0,3}((?:-[\t ]*){3,}|(?:_[ \t]*){3,}|(?:\*[ \t]*){3,})(?:\n+|$)/,E=/(?:[*+-]|\d{1,9}[.)])/,C=/^(?!bull |blockCode|fences|blockquote|heading|html|table)((?:.|\n(?!\s*?\n|bull |blockCode|fences|blockquote|heading|html|table))+?)\n {0,3}(=+|-+) *(?:\n+|$)/,T=$(C).replace(/bull/g,E).replace(/blockCode/g,/(?: {4}| {0,3}\t)/).replace(/fences/g,/ {0,3}(?:`{3,}|~{3,})/).replace(/blockquote/g,/ {0,3}>/).replace(/heading/g,/ {0,3}#{1,6}/).replace(/html/g,/ {0,3}<[^\n>]+>\n/).replace(/\|table/g,"").getRegex(),L=$(C).replace(/bull/g,E).replace(/blockCode/g,/(?: {4}| {0,3}\t)/).replace(/fences/g,/ {0,3}(?:`{3,}|~{3,})/).replace(/blockquote/g,/ {0,3}>/).replace(/heading/g,/ {0,3}#{1,6}/).replace(/html/g,/ {0,3}<[^\n>]+>\n/).replace(/table/g,/ {0,3}\|?(?:[:\- ]*\|)+[\:\- ]*\n/).getRegex(),R=/^([^\n]+(?:\n(?!hr|heading|lheading|blockquote|fences|list|html|table| +\n)[^\n]+)*)/,P=/(?!\s*\])(?:\\.|[^\[\]\\])+/,A=$(/^ {0,3}\[(label)\]: *(?:\n[ \t]*)?([^<\s][^\s]*|<.*?>)(?:(?: +(?:\n[ \t]*)?| *\n[ \t]*)(title))? *(?:\n+|$)/).replace("label",P).replace("title",/(?:"(?:\\"?|[^"\\])*"|'[^'\n]*(?:\n[^'\n]+)*\n?'|\([^()]*\))/).getRegex(),M=$(/^( {0,3}bull)([ \t][^\n]+?)?(?:\n|$)/).replace(/bull/g,E).getRegex(),q="address|article|aside|base|basefont|blockquote|body|caption|center|col|colgroup|dd|details|dialog|dir|div|dl|dt|fieldset|figcaption|figure|footer|form|frame|frameset|h[1-6]|head|header|hr|html|iframe|legend|li|link|main|menu|menuitem|meta|nav|noframes|ol|optgroup|option|p|param|search|section|summary|table|tbody|td|tfoot|th|thead|title|tr|track|ul",O=/<!--(?:-?>|[\s\S]*?(?:-->|$))/,I=$("^ {0,3}(?:<(script|pre|style|textarea)[\\s>][\\s\\S]*?(?:</\\1>[^\\n]*\\n+|$)|comment[^\\n]*(\\n+|$)|<\\?[\\s\\S]*?(?:\\?>\\n*|$)|<![A-Z][\\s\\S]*?(?:>\\n*|$)|<!\\[CDATA\\[[\\s\\S]*?(?:\\]\\]>\\n*|$)|</?(tag)(?: +|\\n|/?>)[\\s\\S]*?(?:(?:\\n[ \t]*)+\\n|$)|<(?!script|pre|style|textarea)([a-z][\\w-]*)(?:attribute)*? */?>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:(?:\\n[ \t]*)+\\n|$)|</(?!script|pre|style|textarea)[a-z][\\w-]*\\s*>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:(?:\\n[ \t]*)+\\n|$))","i").replace("comment",O).replace("tag",q).replace("attribute",/ +[a-zA-Z:_][\w.:-]*(?: *= *"[^"\n]*"| *= *'[^'\n]*'| *= *[^\s"'=<>`]+)?/).getRegex(),B=$(R).replace("hr",S).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("|lheading","").replace("|table","").replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",q).getRegex(),N={blockquote:$(/^( {0,3}> ?(paragraph|[^\n]*)(?:\n|$))+/).replace("paragraph",B).getRegex(),code:/^((?: {4}| {0,3}\t)[^\n]+(?:\n(?:[ \t]*(?:\n|$))*)?)+/,def:A,fences:/^ {0,3}(`{3,}(?=[^`\n]*(?:\n|$))|~{3,})([^\n]*)(?:\n|$)(?:|([\s\S]*?)(?:\n|$))(?: {0,3}\1[~`]* *(?=\n|$)|$)/,heading:/^ {0,3}(#{1,6})(?=\s|$)(.*)(?:\n+|$)/,hr:S,html:I,lheading:T,list:M,newline:/^(?:[ \t]*(?:\n|$))+/,paragraph:B,table:y,text:/^[^\n]+/},H=$("^ *([^\\n ].*)\\n {0,3}((?:\\| *)?:?-+:? *(?:\\| *:?-+:? *)*(?:\\| *)?)(?:\\n((?:(?! *\\n|hr|heading|blockquote|code|fences|list|html).*(?:\\n|$))*)\\n*|$)").replace("hr",S).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("blockquote"," {0,3}>").replace("code","(?: {4}| {0,3}\t)[^\\n]").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",q).getRegex(),z={...N,lheading:L,table:H,paragraph:$(R).replace("hr",S).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("|lheading","").replace("table",H).replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",q).getRegex()},V={...N,html:$("^ *(?:comment *(?:\\n|\\s*$)|<(tag)[\\s\\S]+?</\\1> *(?:\\n{2,}|\\s*$)|<tag(?:\"[^\"]*\"|'[^']*'|\\s[^'\"/>\\s]*)*?/?> *(?:\\n{2,}|\\s*$))").replace("comment",O).replace(/tag/g,"(?!(?:a|em|strong|small|s|cite|q|dfn|abbr|data|time|code|var|samp|kbd|sub|sup|i|b|u|mark|ruby|rt|rp|bdi|bdo|span|br|wbr|ins|del|img)\\b)\\w+(?!:|[^\\w\\s@]*@)\\b").getRegex(),def:/^ *\[([^\]]+)\]: *<?([^\s>]+)>?(?: +(["(][^\n]+[")]))? *(?:\n+|$)/,heading:/^(#{1,6})(.*)(?:\n+|$)/,fences:y,lheading:/^(.+?)\n {0,3}(=+|-+) *(?:\n+|$)/,paragraph:$(R).replace("hr",S).replace("heading"," *#{1,6} *[^\n]").replace("lheading",T).replace("|table","").replace("blockquote"," {0,3}>").replace("|fences","").replace("|list","").replace("|html","").replace("|tag","").getRegex()},D=/^( {2,}|\\)\n(?!\s*$)/,Z=/[\p{P}\p{S}]/u,j=/[\s\p{P}\p{S}]/u,F=/[^\s\p{P}\p{S}]/u,W=$(/^((?![*_])punctSpace)/,"u").replace(/punctSpace/g,j).getRegex(),U=/(?!~)[\p{P}\p{S}]/u,Y=/^(?:\*+(?:((?!\*)punct)|[^\s*]))|^_+(?:((?!_)punct)|([^\s_]))/,G=$(Y,"u").replace(/punct/g,Z).getRegex(),X=$(Y,"u").replace(/punct/g,U).getRegex(),J="^[^_*]*?__[^_*]*?\\*[^_*]*?(?=__)|[^*]+(?=[^*])|(?!\\*)punct(\\*+)(?=[\\s]|$)|notPunctSpace(\\*+)(?!\\*)(?=punctSpace|$)|(?!\\*)punctSpace(\\*+)(?=notPunctSpace)|[\\s](\\*+)(?!\\*)(?=punct)|(?!\\*)punct(\\*+)(?!\\*)(?=punct)|notPunctSpace(\\*+)(?=notPunctSpace)",Q=$(J,"gu").replace(/notPunctSpace/g,F).replace(/punctSpace/g,j).replace(/punct/g,Z).getRegex(),K=$(J,"gu").replace(/notPunctSpace/g,/(?:[^\s\p{P}\p{S}]|~)/u).replace(/punctSpace/g,/(?!~)[\s\p{P}\p{S}]/u).replace(/punct/g,U).getRegex(),ee=$("^[^_*]*?\\*\\*[^_*]*?_[^_*]*?(?=\\*\\*)|[^_]+(?=[^_])|(?!_)punct(_+)(?=[\\s]|$)|notPunctSpace(_+)(?!_)(?=punctSpace|$)|(?!_)punctSpace(_+)(?=notPunctSpace)|[\\s](_+)(?!_)(?=punct)|(?!_)punct(_+)(?!_)(?=punct)","gu").replace(/notPunctSpace/g,F).replace(/punctSpace/g,j).replace(/punct/g,Z).getRegex(),te=$(/\\(punct)/,"gu").replace(/punct/g,Z).getRegex(),ne=$(/^<(scheme:[^\s\x00-\x1f<>]*|email)>/).replace("scheme",/[a-zA-Z][a-zA-Z0-9+.-]{1,31}/).replace("email",/[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+(@)[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+(?![-_])/).getRegex(),se=$(O).replace("(?:--\x3e|$)","--\x3e").getRegex(),ie=$("^comment|^</[a-zA-Z][\\w:-]*\\s*>|^<[a-zA-Z][\\w-]*(?:attribute)*?\\s*/?>|^<\\?[\\s\\S]*?\\?>|^<![a-zA-Z]+\\s[\\s\\S]*?>|^<!\\[CDATA\\[[\\s\\S]*?\\]\\]>").replace("comment",se).replace("attribute",/\s+[a-zA-Z:_][\w.:-]*(?:\s*=\s*"[^"]*"|\s*=\s*'[^']*'|\s*=\s*[^\s"'=<>`]+)?/).getRegex(),re=/(?:\[(?:\\.|[^\[\]\\])*\]|\\.|`[^`]*`|[^\[\]\\`])*?/,ae=$(/^!?\[(label)\]\(\s*(href)(?:(?:[ \t]*(?:\n[ \t]*)?)(title))?\s*\)/).replace("label",re).replace("href",/<(?:\\.|[^\n<>\\])+>|[^ \t\n\x00-\x1f]*/).replace("title",/"(?:\\"?|[^"\\])*"|'(?:\\'?|[^'\\])*'|\((?:\\\)?|[^)\\])*\)/).getRegex(),oe=$(/^!?\[(label)\]\[(ref)\]/).replace("label",re).replace("ref",P).getRegex(),ce=$(/^!?\[(ref)\](?:\[\])?/).replace("ref",P).getRegex(),le={_backpedal:y,anyPunctuation:te,autolink:ne,blockSkip:/\[[^[\]]*?\]\((?:\\.|[^\\\(\)]|\((?:\\.|[^\\\(\)])*\))*\)|`[^`]*?`|<[^<>]*?>/g,br:D,code:/^(`+)([^`]|[^`][\s\S]*?[^`])\1(?!`)/,del:y,emStrongLDelim:G,emStrongRDelimAst:Q,emStrongRDelimUnd:ee,escape:/^\\([!"#$%&'()*+,\-./:;<=>?@\[\]\\^_`{|}~])/,link:ae,nolink:ce,punctuation:W,reflink:oe,reflinkSearch:$("reflink|nolink(?!\\()","g").replace("reflink",oe).replace("nolink",ce).getRegex(),tag:ie,text:/^(`+|[^`])(?:(?= {2,}\n)|[\s\S]*?(?:(?=[\\<!\[`*_]|\b_|$)|[^ ](?= {2,}\n)))/,url:y},he={...le,link:$(/^!?\[(label)\]\((.*?)\)/).replace("label",re).getRegex(),reflink:$(/^!?\[(label)\]\s*\[([^\]]*)\]/).replace("label",re).getRegex()},pe={...le,emStrongRDelimAst:K,emStrongLDelim:X,url:$(/^((?:ftp|https?):\/\/|www\.)(?:[a-zA-Z0-9\-]+\.?)+[^\s<]*|^email/,"i").replace("email",/[A-Za-z0-9._+-]+(@)[a-zA-Z0-9-_]+(?:\.[a-zA-Z0-9-_]*[a-zA-Z0-9])+(?![-_])/).getRegex(),_backpedal:/(?:[^?!.,:;*_'"~()&]+|\([^)]*\)|&(?![a-zA-Z0-9]+;$)|[?!.,:;*_'"~)]+(?!$))+/,del:/^(~~?)(?=[^\s~])((?:\\.|[^\\])*?(?:\\.|[^\s~\\]))\1(?=[^~]|$)/,text:/^([`~]+|[^`~])(?:(?= {2,}\n)|(?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@)|[\s\S]*?(?:(?=[\\<!\[`*~_]|\b_|https?:\/\/|ftp:\/\/|www\.|$)|[^ ](?= {2,}\n)|[^a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-](?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@)))/},de={...pe,br:$(D).replace("{2,}","*").getRegex(),text:$(pe.text).replace("\\b_","\\b_| {2,}\\n").replace(/\{2,\}/g,"*").getRegex()},ue={normal:N,gfm:z,pedantic:V},ge={normal:le,gfm:pe,breaks:de,pedantic:he},me={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},fe=e=>me[e];function we(e,t){if(t){if(_.escapeTest.test(e))return e.replace(_.escapeReplace,fe)}else if(_.escapeTestNoEncode.test(e))return e.replace(_.escapeReplaceNoEncode,fe);return e}function be(e){try{e=encodeURI(e).replace(_.percentDecode,"%")}catch{return null}return e}function xe(e,t){const n=e.replace(_.findPipe,((e,t,n)=>{let s=!1,i=t;for(;--i>=0&&"\\"===n[i];)s=!s;return s?"|":" |"})).split(_.splitPipe);let s=0;if(n[0].trim()||n.shift(),n.length>0&&!n.at(-1)?.trim()&&n.pop(),t)if(n.length>t)n.splice(t);else for(;n.length<t;)n.push("");for(;s<n.length;s++)n[s]=n[s].trim().replace(_.slashPipe,"|");return n}function ke(e,t,n){const s=e.length;if(0===s)return"";let i=0;for(;i<s&&e.charAt(s-i-1)===t;)i++;return e.slice(0,s-i)}function ve(e,t,n,s,i){const r=t.href,a=t.title||null,o=e[1].replace(i.other.outputLinkReplace,"$1");if("!"!==e[0].charAt(0)){s.state.inLink=!0;const e={type:"link",raw:n,href:r,title:a,text:o,tokens:s.inlineTokens(o)};return s.state.inLink=!1,e}return{type:"image",raw:n,href:r,title:a,text:o}}class ye{options;rules;lexer;constructor(e){this.options=e||k}space(e){const t=this.rules.block.newline.exec(e);if(t&&t[0].length>0)return{type:"space",raw:t[0]}}code(e){const t=this.rules.block.code.exec(e);if(t){const e=t[0].replace(this.rules.other.codeRemoveIndent,"");return{type:"code",raw:t[0],codeBlockStyle:"indented",text:this.options.pedantic?e:ke(e,"\n")}}}fences(e){const t=this.rules.block.fences.exec(e);if(t){const e=t[0],n=function(e,t,n){const s=e.match(n.other.indentCodeCompensation);if(null===s)return t;const i=s[1];return t.split("\n").map((e=>{const t=e.match(n.other.beginningSpace);if(null===t)return e;const[s]=t;return s.length>=i.length?e.slice(i.length):e})).join("\n")}(e,t[3]||"",this.rules);return{type:"code",raw:e,lang:t[2]?t[2].trim().replace(this.rules.inline.anyPunctuation,"$1"):t[2],text:n}}}heading(e){const t=this.rules.block.heading.exec(e);if(t){let e=t[2].trim();if(this.rules.other.endingHash.test(e)){const t=ke(e,"#");this.options.pedantic?e=t.trim():t&&!this.rules.other.endingSpaceChar.test(t)||(e=t.trim())}return{type:"heading",raw:t[0],depth:t[1].length,text:e,tokens:this.lexer.inline(e)}}}hr(e){const t=this.rules.block.hr.exec(e);if(t)return{type:"hr",raw:ke(t[0],"\n")}}blockquote(e){const t=this.rules.block.blockquote.exec(e);if(t){let e=ke(t[0],"\n").split("\n"),n="",s="";const i=[];for(;e.length>0;){let t=!1;const r=[];let a;for(a=0;a<e.length;a++)if(this.rules.other.blockquoteStart.test(e[a]))r.push(e[a]),t=!0;else{if(t)break;r.push(e[a])}e=e.slice(a);const o=r.join("\n"),c=o.replace(this.rules.other.blockquoteSetextReplace,"\n    $1").replace(this.rules.other.blockquoteSetextReplace2,"");n=n?`${n}\n${o}`:o,s=s?`${s}\n${c}`:c;const l=this.lexer.state.top;if(this.lexer.state.top=!0,this.lexer.blockTokens(c,i,!0),this.lexer.state.top=l,0===e.length)break;const h=i.at(-1);if("code"===h?.type)break;if("blockquote"===h?.type){const t=h,r=t.raw+"\n"+e.join("\n"),a=this.blockquote(r);i[i.length-1]=a,n=n.substring(0,n.length-t.raw.length)+a.raw,s=s.substring(0,s.length-t.text.length)+a.text;break}if("list"!==h?.type);else{const t=h,r=t.raw+"\n"+e.join("\n"),a=this.list(r);i[i.length-1]=a,n=n.substring(0,n.length-h.raw.length)+a.raw,s=s.substring(0,s.length-t.raw.length)+a.raw,e=r.substring(i.at(-1).raw.length).split("\n")}}return{type:"blockquote",raw:n,tokens:i,text:s}}}list(e){let t=this.rules.block.list.exec(e);if(t){let n=t[1].trim();const s=n.length>1,i={type:"list",raw:"",ordered:s,start:s?+n.slice(0,-1):"",loose:!1,items:[]};n=s?`\\d{1,9}\\${n.slice(-1)}`:`\\${n}`,this.options.pedantic&&(n=s?n:"[*+-]");const r=this.rules.other.listItemRegex(n);let a=!1;for(;e;){let n=!1,s="",o="";if(!(t=r.exec(e)))break;if(this.rules.block.hr.test(e))break;s=t[0],e=e.substring(s.length);let c=t[2].split("\n",1)[0].replace(this.rules.other.listReplaceTabs,(e=>" ".repeat(3*e.length))),l=e.split("\n",1)[0],h=!c.trim(),p=0;if(this.options.pedantic?(p=2,o=c.trimStart()):h?p=t[1].length+1:(p=t[2].search(this.rules.other.nonSpaceChar),p=p>4?1:p,o=c.slice(p),p+=t[1].length),h&&this.rules.other.blankLine.test(l)&&(s+=l+"\n",e=e.substring(l.length+1),n=!0),!n){const t=this.rules.other.nextBulletRegex(p),n=this.rules.other.hrRegex(p),i=this.rules.other.fencesBeginRegex(p),r=this.rules.other.headingBeginRegex(p),a=this.rules.other.htmlBeginRegex(p);for(;e;){const d=e.split("\n",1)[0];let u;if(l=d,this.options.pedantic?(l=l.replace(this.rules.other.listReplaceNesting,"  "),u=l):u=l.replace(this.rules.other.tabCharGlobal,"    "),i.test(l))break;if(r.test(l))break;if(a.test(l))break;if(t.test(l))break;if(n.test(l))break;if(u.search(this.rules.other.nonSpaceChar)>=p||!l.trim())o+="\n"+u.slice(p);else{if(h)break;if(c.replace(this.rules.other.tabCharGlobal,"    ").search(this.rules.other.nonSpaceChar)>=4)break;if(i.test(c))break;if(r.test(c))break;if(n.test(c))break;o+="\n"+l}h||l.trim()||(h=!0),s+=d+"\n",e=e.substring(d.length+1),c=u.slice(p)}}i.loose||(a?i.loose=!0:this.rules.other.doubleBlankLine.test(s)&&(a=!0));let d,u=null;this.options.gfm&&(u=this.rules.other.listIsTask.exec(o),u&&(d="[ ] "!==u[0],o=o.replace(this.rules.other.listReplaceTask,""))),i.items.push({type:"list_item",raw:s,task:!!u,checked:d,loose:!1,text:o,tokens:[]}),i.raw+=s}const o=i.items.at(-1);if(!o)return;o.raw=o.raw.trimEnd(),o.text=o.text.trimEnd(),i.raw=i.raw.trimEnd();for(let e=0;e<i.items.length;e++)if(this.lexer.state.top=!1,i.items[e].tokens=this.lexer.blockTokens(i.items[e].text,[]),!i.loose){const t=i.items[e].tokens.filter((e=>"space"===e.type)),n=t.length>0&&t.some((e=>this.rules.other.anyLine.test(e.raw)));i.loose=n}if(i.loose)for(let e=0;e<i.items.length;e++)i.items[e].loose=!0;return i}}html(e){const t=this.rules.block.html.exec(e);if(t)return{type:"html",block:!0,raw:t[0],pre:"pre"===t[1]||"script"===t[1]||"style"===t[1],text:t[0]}}def(e){const t=this.rules.block.def.exec(e);if(t){const e=t[1].toLowerCase().replace(this.rules.other.multipleSpaceGlobal," "),n=t[2]?t[2].replace(this.rules.other.hrefBrackets,"$1").replace(this.rules.inline.anyPunctuation,"$1"):"",s=t[3]?t[3].substring(1,t[3].length-1).replace(this.rules.inline.anyPunctuation,"$1"):t[3];return{type:"def",tag:e,raw:t[0],href:n,title:s}}}table(e){const t=this.rules.block.table.exec(e);if(!t)return;if(!this.rules.other.tableDelimiter.test(t[2]))return;const n=xe(t[1]),s=t[2].replace(this.rules.other.tableAlignChars,"").split("|"),i=t[3]?.trim()?t[3].replace(this.rules.other.tableRowBlankLine,"").split("\n"):[],r={type:"table",raw:t[0],header:[],align:[],rows:[]};if(n.length===s.length){for(const e of s)this.rules.other.tableAlignRight.test(e)?r.align.push("right"):this.rules.other.tableAlignCenter.test(e)?r.align.push("center"):this.rules.other.tableAlignLeft.test(e)?r.align.push("left"):r.align.push(null);for(let e=0;e<n.length;e++)r.header.push({text:n[e],tokens:this.lexer.inline(n[e]),header:!0,align:r.align[e]});for(const e of i)r.rows.push(xe(e,r.header.length).map(((e,t)=>({text:e,tokens:this.lexer.inline(e),header:!1,align:r.align[t]}))));return r}}lheading(e){const t=this.rules.block.lheading.exec(e);if(t)return{type:"heading",raw:t[0],depth:"="===t[2].charAt(0)?1:2,text:t[1],tokens:this.lexer.inline(t[1])}}paragraph(e){const t=this.rules.block.paragraph.exec(e);if(t){const e="\n"===t[1].charAt(t[1].length-1)?t[1].slice(0,-1):t[1];return{type:"paragraph",raw:t[0],text:e,tokens:this.lexer.inline(e)}}}text(e){const t=this.rules.block.text.exec(e);if(t)return{type:"text",raw:t[0],text:t[0],tokens:this.lexer.inline(t[0])}}escape(e){const t=this.rules.inline.escape.exec(e);if(t)return{type:"escape",raw:t[0],text:t[1]}}tag(e){const t=this.rules.inline.tag.exec(e);if(t)return!this.lexer.state.inLink&&this.rules.other.startATag.test(t[0])?this.lexer.state.inLink=!0:this.lexer.state.inLink&&this.rules.other.endATag.test(t[0])&&(this.lexer.state.inLink=!1),!this.lexer.state.inRawBlock&&this.rules.other.startPreScriptTag.test(t[0])?this.lexer.state.inRawBlock=!0:this.lexer.state.inRawBlock&&this.rules.other.endPreScriptTag.test(t[0])&&(this.lexer.state.inRawBlock=!1),{type:"html",raw:t[0],inLink:this.lexer.state.inLink,inRawBlock:this.lexer.state.inRawBlock,block:!1,text:t[0]}}link(e){const t=this.rules.inline.link.exec(e);if(t){const e=t[2].trim();if(!this.options.pedantic&&this.rules.other.startAngleBracket.test(e)){if(!this.rules.other.endAngleBracket.test(e))return;const t=ke(e.slice(0,-1),"\\");if((e.length-t.length)%2==0)return}else{const e=function(e,t){if(-1===e.indexOf(t[1]))return-1;let n=0;for(let s=0;s<e.length;s++)if("\\"===e[s])s++;else if(e[s]===t[0])n++;else if(e[s]===t[1]&&(n--,n<0))return s;return n>0?-2:-1}(t[2],"()");if(-2===e)return;if(e>-1){const n=(0===t[0].indexOf("!")?5:4)+t[1].length+e;t[2]=t[2].substring(0,e),t[0]=t[0].substring(0,n).trim(),t[3]=""}}let n=t[2],s="";if(this.options.pedantic){const e=this.rules.other.pedanticHrefTitle.exec(n);e&&(n=e[1],s=e[3])}else s=t[3]?t[3].slice(1,-1):"";return n=n.trim(),this.rules.other.startAngleBracket.test(n)&&(n=this.options.pedantic&&!this.rules.other.endAngleBracket.test(e)?n.slice(1):n.slice(1,-1)),ve(t,{href:n?n.replace(this.rules.inline.anyPunctuation,"$1"):n,title:s?s.replace(this.rules.inline.anyPunctuation,"$1"):s},t[0],this.lexer,this.rules)}}reflink(e,t){let n;if((n=this.rules.inline.reflink.exec(e))||(n=this.rules.inline.nolink.exec(e))){const e=t[(n[2]||n[1]).replace(this.rules.other.multipleSpaceGlobal," ").toLowerCase()];if(!e){const e=n[0].charAt(0);return{type:"text",raw:e,text:e}}return ve(n,e,n[0],this.lexer,this.rules)}}emStrong(e,t,n=""){let s=this.rules.inline.emStrongLDelim.exec(e);if(s&&(!s[3]||!n.match(this.rules.other.unicodeAlphaNumeric))&&(!s[1]&&!s[2]||!n||this.rules.inline.punctuation.exec(n))){const n=[...s[0]].length-1;let i,r,a=n,o=0;const c="*"===s[0][0]?this.rules.inline.emStrongRDelimAst:this.rules.inline.emStrongRDelimUnd;for(c.lastIndex=0,t=t.slice(-1*e.length+n);null!=(s=c.exec(t));){if(i=s[1]||s[2]||s[3]||s[4]||s[5]||s[6],!i)continue;if(r=[...i].length,s[3]||s[4]){a+=r;continue}if((s[5]||s[6])&&n%3&&!((n+r)%3)){o+=r;continue}if(a-=r,a>0)continue;r=Math.min(r,r+a+o);const t=[...s[0]][0].length,c=e.slice(0,n+s.index+t+r);if(Math.min(n,r)%2){const e=c.slice(1,-1);return{type:"em",raw:c,text:e,tokens:this.lexer.inlineTokens(e)}}const l=c.slice(2,-2);return{type:"strong",raw:c,text:l,tokens:this.lexer.inlineTokens(l)}}}}codespan(e){const t=this.rules.inline.code.exec(e);if(t){let e=t[2].replace(this.rules.other.newLineCharGlobal," ");const n=this.rules.other.nonSpaceChar.test(e),s=this.rules.other.startingSpaceChar.test(e)&&this.rules.other.endingSpaceChar.test(e);return n&&s&&(e=e.substring(1,e.length-1)),{type:"codespan",raw:t[0],text:e}}}br(e){const t=this.rules.inline.br.exec(e);if(t)return{type:"br",raw:t[0]}}del(e){const t=this.rules.inline.del.exec(e);if(t)return{type:"del",raw:t[0],text:t[2],tokens:this.lexer.inlineTokens(t[2])}}autolink(e){const t=this.rules.inline.autolink.exec(e);if(t){let e,n;return"@"===t[2]?(e=t[1],n="mailto:"+e):(e=t[1],n=e),{type:"link",raw:t[0],text:e,href:n,tokens:[{type:"text",raw:e,text:e}]}}}url(e){let t;if(t=this.rules.inline.url.exec(e)){let e,n;if("@"===t[2])e=t[0],n="mailto:"+e;else{let s;do{s=t[0],t[0]=this.rules.inline._backpedal.exec(t[0])?.[0]??""}while(s!==t[0]);e=t[0],n="www."===t[1]?"http://"+t[0]:t[0]}return{type:"link",raw:t[0],text:e,href:n,tokens:[{type:"text",raw:e,text:e}]}}}inlineText(e){const t=this.rules.inline.text.exec(e);if(t){const e=this.lexer.state.inRawBlock;return{type:"text",raw:t[0],text:t[0],escaped:e}}}}class $e{tokens;options;state;tokenizer;inlineQueue;constructor(e){this.tokens=[],this.tokens.links=Object.create(null),this.options=e||k,this.options.tokenizer=this.options.tokenizer||new ye,this.tokenizer=this.options.tokenizer,this.tokenizer.options=this.options,this.tokenizer.lexer=this,this.inlineQueue=[],this.state={inLink:!1,inRawBlock:!1,top:!0};const t={other:_,block:ue.normal,inline:ge.normal};this.options.pedantic?(t.block=ue.pedantic,t.inline=ge.pedantic):this.options.gfm&&(t.block=ue.gfm,this.options.breaks?t.inline=ge.breaks:t.inline=ge.gfm),this.tokenizer.rules=t}static get rules(){return{block:ue,inline:ge}}static lex(e,t){return new $e(t).lex(e)}static lexInline(e,t){return new $e(t).inlineTokens(e)}lex(e){e=e.replace(_.carriageReturn,"\n"),this.blockTokens(e,this.tokens);for(let e=0;e<this.inlineQueue.length;e++){const t=this.inlineQueue[e];this.inlineTokens(t.src,t.tokens)}return this.inlineQueue=[],this.tokens}blockTokens(e,t=[],n=!1){for(this.options.pedantic&&(e=e.replace(_.tabCharGlobal,"    ").replace(_.spaceLine,""));e;){let s;if(this.options.extensions?.block?.some((n=>!!(s=n.call({lexer:this},e,t))&&(e=e.substring(s.raw.length),t.push(s),!0))))continue;if(s=this.tokenizer.space(e)){e=e.substring(s.raw.length);const n=t.at(-1);1===s.raw.length&&void 0!==n?n.raw+="\n":t.push(s);continue}if(s=this.tokenizer.code(e)){e=e.substring(s.raw.length);const n=t.at(-1);"paragraph"===n?.type||"text"===n?.type?(n.raw+="\n"+s.raw,n.text+="\n"+s.text,this.inlineQueue.at(-1).src=n.text):t.push(s);continue}if(s=this.tokenizer.fences(e)){e=e.substring(s.raw.length),t.push(s);continue}if(s=this.tokenizer.heading(e)){e=e.substring(s.raw.length),t.push(s);continue}if(s=this.tokenizer.hr(e)){e=e.substring(s.raw.length),t.push(s);continue}if(s=this.tokenizer.blockquote(e)){e=e.substring(s.raw.length),t.push(s);continue}if(s=this.tokenizer.list(e)){e=e.substring(s.raw.length),t.push(s);continue}if(s=this.tokenizer.html(e)){e=e.substring(s.raw.length),t.push(s);continue}if(s=this.tokenizer.def(e)){e=e.substring(s.raw.length);const n=t.at(-1);"paragraph"===n?.type||"text"===n?.type?(n.raw+="\n"+s.raw,n.text+="\n"+s.raw,this.inlineQueue.at(-1).src=n.text):this.tokens.links[s.tag]||(this.tokens.links[s.tag]={href:s.href,title:s.title});continue}if(s=this.tokenizer.table(e)){e=e.substring(s.raw.length),t.push(s);continue}if(s=this.tokenizer.lheading(e)){e=e.substring(s.raw.length),t.push(s);continue}let i=e;if(this.options.extensions?.startBlock){let t=1/0;const n=e.slice(1);let s;this.options.extensions.startBlock.forEach((e=>{s=e.call({lexer:this},n),"number"==typeof s&&s>=0&&(t=Math.min(t,s))})),t<1/0&&t>=0&&(i=e.substring(0,t+1))}if(this.state.top&&(s=this.tokenizer.paragraph(i))){const r=t.at(-1);n&&"paragraph"===r?.type?(r.raw+="\n"+s.raw,r.text+="\n"+s.text,this.inlineQueue.pop(),this.inlineQueue.at(-1).src=r.text):t.push(s),n=i.length!==e.length,e=e.substring(s.raw.length)}else if(s=this.tokenizer.text(e)){e=e.substring(s.raw.length);const n=t.at(-1);"text"===n?.type?(n.raw+="\n"+s.raw,n.text+="\n"+s.text,this.inlineQueue.pop(),this.inlineQueue.at(-1).src=n.text):t.push(s)}else if(e){const t="Infinite loop on byte: "+e.charCodeAt(0);if(this.options.silent){console.error(t);break}throw new Error(t)}}return this.state.top=!0,t}inline(e,t=[]){return this.inlineQueue.push({src:e,tokens:t}),t}inlineTokens(e,t=[]){let n=e,s=null;if(this.tokens.links){const e=Object.keys(this.tokens.links);if(e.length>0)for(;null!=(s=this.tokenizer.rules.inline.reflinkSearch.exec(n));)e.includes(s[0].slice(s[0].lastIndexOf("[")+1,-1))&&(n=n.slice(0,s.index)+"["+"a".repeat(s[0].length-2)+"]"+n.slice(this.tokenizer.rules.inline.reflinkSearch.lastIndex))}for(;null!=(s=this.tokenizer.rules.inline.anyPunctuation.exec(n));)n=n.slice(0,s.index)+"++"+n.slice(this.tokenizer.rules.inline.anyPunctuation.lastIndex);for(;null!=(s=this.tokenizer.rules.inline.blockSkip.exec(n));)n=n.slice(0,s.index)+"["+"a".repeat(s[0].length-2)+"]"+n.slice(this.tokenizer.rules.inline.blockSkip.lastIndex);let i=!1,r="";for(;e;){let s;if(i||(r=""),i=!1,this.options.extensions?.inline?.some((n=>!!(s=n.call({lexer:this},e,t))&&(e=e.substring(s.raw.length),t.push(s),!0))))continue;if(s=this.tokenizer.escape(e)){e=e.substring(s.raw.length),t.push(s);continue}if(s=this.tokenizer.tag(e)){e=e.substring(s.raw.length),t.push(s);continue}if(s=this.tokenizer.link(e)){e=e.substring(s.raw.length),t.push(s);continue}if(s=this.tokenizer.reflink(e,this.tokens.links)){e=e.substring(s.raw.length);const n=t.at(-1);"text"===s.type&&"text"===n?.type?(n.raw+=s.raw,n.text+=s.text):t.push(s);continue}if(s=this.tokenizer.emStrong(e,n,r)){e=e.substring(s.raw.length),t.push(s);continue}if(s=this.tokenizer.codespan(e)){e=e.substring(s.raw.length),t.push(s);continue}if(s=this.tokenizer.br(e)){e=e.substring(s.raw.length),t.push(s);continue}if(s=this.tokenizer.del(e)){e=e.substring(s.raw.length),t.push(s);continue}if(s=this.tokenizer.autolink(e)){e=e.substring(s.raw.length),t.push(s);continue}if(!this.state.inLink&&(s=this.tokenizer.url(e))){e=e.substring(s.raw.length),t.push(s);continue}let a=e;if(this.options.extensions?.startInline){let t=1/0;const n=e.slice(1);let s;this.options.extensions.startInline.forEach((e=>{s=e.call({lexer:this},n),"number"==typeof s&&s>=0&&(t=Math.min(t,s))})),t<1/0&&t>=0&&(a=e.substring(0,t+1))}if(s=this.tokenizer.inlineText(a)){e=e.substring(s.raw.length),"_"!==s.raw.slice(-1)&&(r=s.raw.slice(-1)),i=!0;const n=t.at(-1);"text"===n?.type?(n.raw+=s.raw,n.text+=s.text):t.push(s)}else if(e){const t="Infinite loop on byte: "+e.charCodeAt(0);if(this.options.silent){console.error(t);break}throw new Error(t)}}return t}}class _e{options;parser;constructor(e){this.options=e||k}space(e){return""}code({text:e,lang:t,escaped:n}){const s=(t||"").match(_.notSpaceStart)?.[0],i=e.replace(_.endingNewline,"")+"\n";return s?'<pre><code class="language-'+we(s)+'">'+(n?i:we(i,!0))+"</code></pre>\n":"<pre><code>"+(n?i:we(i,!0))+"</code></pre>\n"}blockquote({tokens:e}){return`<blockquote>\n${this.parser.parse(e)}</blockquote>\n`}html({text:e}){return e}heading({tokens:e,depth:t}){return`<h${t}>${this.parser.parseInline(e)}</h${t}>\n`}hr(e){return"<hr>\n"}list(e){const t=e.ordered,n=e.start;let s="";for(let t=0;t<e.items.length;t++){const n=e.items[t];s+=this.listitem(n)}const i=t?"ol":"ul";return"<"+i+(t&&1!==n?' start="'+n+'"':"")+">\n"+s+"</"+i+">\n"}listitem(e){let t="";if(e.task){const n=this.checkbox({checked:!!e.checked});e.loose?"paragraph"===e.tokens[0]?.type?(e.tokens[0].text=n+" "+e.tokens[0].text,e.tokens[0].tokens&&e.tokens[0].tokens.length>0&&"text"===e.tokens[0].tokens[0].type&&(e.tokens[0].tokens[0].text=n+" "+we(e.tokens[0].tokens[0].text),e.tokens[0].tokens[0].escaped=!0)):e.tokens.unshift({type:"text",raw:n+" ",text:n+" ",escaped:!0}):t+=n+" "}return t+=this.parser.parse(e.tokens,!!e.loose),`<li>${t}</li>\n`}checkbox({checked:e}){return"<input "+(e?'checked="" ':"")+'disabled="" type="checkbox">'}paragraph({tokens:e}){return`<p>${this.parser.parseInline(e)}</p>\n`}table(e){let t="",n="";for(let t=0;t<e.header.length;t++)n+=this.tablecell(e.header[t]);t+=this.tablerow({text:n});let s="";for(let t=0;t<e.rows.length;t++){const i=e.rows[t];n="";for(let e=0;e<i.length;e++)n+=this.tablecell(i[e]);s+=this.tablerow({text:n})}return s&&(s=`<tbody>${s}</tbody>`),"<table>\n<thead>\n"+t+"</thead>\n"+s+"</table>\n"}tablerow({text:e}){return`<tr>\n${e}</tr>\n`}tablecell(e){const t=this.parser.parseInline(e.tokens),n=e.header?"th":"td";return(e.align?`<${n} align="${e.align}">`:`<${n}>`)+t+`</${n}>\n`}strong({tokens:e}){return`<strong>${this.parser.parseInline(e)}</strong>`}em({tokens:e}){return`<em>${this.parser.parseInline(e)}</em>`}codespan({text:e}){return`<code>${we(e,!0)}</code>`}br(e){return"<br>"}del({tokens:e}){return`<del>${this.parser.parseInline(e)}</del>`}link({href:e,title:t,tokens:n}){const s=this.parser.parseInline(n),i=be(e);if(null===i)return s;let r='<a href="'+(e=i)+'"';return t&&(r+=' title="'+we(t)+'"'),r+=">"+s+"</a>",r}image({href:e,title:t,text:n}){const s=be(e);if(null===s)return we(n);let i=`<img src="${e=s}" alt="${n}"`;return t&&(i+=` title="${we(t)}"`),i+=">",i}text(e){return"tokens"in e&&e.tokens?this.parser.parseInline(e.tokens):"escaped"in e&&e.escaped?e.text:we(e.text)}}class Se{strong({text:e}){return e}em({text:e}){return e}codespan({text:e}){return e}del({text:e}){return e}html({text:e}){return e}text({text:e}){return e}link({text:e}){return""+e}image({text:e}){return""+e}br(){return""}}class Ee{options;renderer;textRenderer;constructor(e){this.options=e||k,this.options.renderer=this.options.renderer||new _e,this.renderer=this.options.renderer,this.renderer.options=this.options,this.renderer.parser=this,this.textRenderer=new Se}static parse(e,t){return new Ee(t).parse(e)}static parseInline(e,t){return new Ee(t).parseInline(e)}parse(e,t=!0){let n="";for(let s=0;s<e.length;s++){const i=e[s];if(this.options.extensions?.renderers?.[i.type]){const e=i,t=this.options.extensions.renderers[e.type].call({parser:this},e);if(!1!==t||!["space","hr","heading","code","table","blockquote","list","html","paragraph","text"].includes(e.type)){n+=t||"";continue}}const r=i;switch(r.type){case"space":n+=this.renderer.space(r);continue;case"hr":n+=this.renderer.hr(r);continue;case"heading":n+=this.renderer.heading(r);continue;case"code":n+=this.renderer.code(r);continue;case"table":n+=this.renderer.table(r);continue;case"blockquote":n+=this.renderer.blockquote(r);continue;case"list":n+=this.renderer.list(r);continue;case"html":n+=this.renderer.html(r);continue;case"paragraph":n+=this.renderer.paragraph(r);continue;case"text":{let i=r,a=this.renderer.text(i);for(;s+1<e.length&&"text"===e[s+1].type;)i=e[++s],a+="\n"+this.renderer.text(i);n+=t?this.renderer.paragraph({type:"paragraph",raw:a,text:a,tokens:[{type:"text",raw:a,text:a,escaped:!0}]}):a;continue}default:{const e='Token with "'+r.type+'" type was not found.';if(this.options.silent)return console.error(e),"";throw new Error(e)}}}return n}parseInline(e,t=this.renderer){let n="";for(let s=0;s<e.length;s++){const i=e[s];if(this.options.extensions?.renderers?.[i.type]){const e=this.options.extensions.renderers[i.type].call({parser:this},i);if(!1!==e||!["escape","html","link","image","strong","em","codespan","br","del","text"].includes(i.type)){n+=e||"";continue}}const r=i;switch(r.type){case"escape":case"text":n+=t.text(r);break;case"html":n+=t.html(r);break;case"link":n+=t.link(r);break;case"image":n+=t.image(r);break;case"strong":n+=t.strong(r);break;case"em":n+=t.em(r);break;case"codespan":n+=t.codespan(r);break;case"br":n+=t.br(r);break;case"del":n+=t.del(r);break;default:{const e='Token with "'+r.type+'" type was not found.';if(this.options.silent)return console.error(e),"";throw new Error(e)}}}return n}}class Ce{options;block;constructor(e){this.options=e||k}static passThroughHooks=new Set(["preprocess","postprocess","processAllTokens"]);preprocess(e){return e}postprocess(e){return e}processAllTokens(e){return e}provideLexer(){return this.block?$e.lex:$e.lexInline}provideParser(){return this.block?Ee.parse:Ee.parseInline}}const Te=new class{defaults={async:!1,breaks:!1,extensions:null,gfm:!0,hooks:null,pedantic:!1,renderer:null,silent:!1,tokenizer:null,walkTokens:null};options=this.setOptions;parse=this.parseMarkdown(!0);parseInline=this.parseMarkdown(!1);Parser=Ee;Renderer=_e;TextRenderer=Se;Lexer=$e;Tokenizer=ye;Hooks=Ce;constructor(...e){this.use(...e)}walkTokens(e,t){let n=[];for(const s of e)switch(n=n.concat(t.call(this,s)),s.type){case"table":{const e=s;for(const s of e.header)n=n.concat(this.walkTokens(s.tokens,t));for(const s of e.rows)for(const e of s)n=n.concat(this.walkTokens(e.tokens,t));break}case"list":{const e=s;n=n.concat(this.walkTokens(e.items,t));break}default:{const e=s;this.defaults.extensions?.childTokens?.[e.type]?this.defaults.extensions.childTokens[e.type].forEach((s=>{const i=e[s].flat(1/0);n=n.concat(this.walkTokens(i,t))})):e.tokens&&(n=n.concat(this.walkTokens(e.tokens,t)))}}return n}use(...e){const t=this.defaults.extensions||{renderers:{},childTokens:{}};return e.forEach((e=>{const n={...e};if(n.async=this.defaults.async||n.async||!1,e.extensions&&(e.extensions.forEach((e=>{if(!e.name)throw new Error("extension name required");if("renderer"in e){const n=t.renderers[e.name];t.renderers[e.name]=n?function(...t){let s=e.renderer.apply(this,t);return!1===s&&(s=n.apply(this,t)),s}:e.renderer}if("tokenizer"in e){if(!e.level||"block"!==e.level&&"inline"!==e.level)throw new Error("extension level must be 'block' or 'inline'");const n=t[e.level];n?n.unshift(e.tokenizer):t[e.level]=[e.tokenizer],e.start&&("block"===e.level?t.startBlock?t.startBlock.push(e.start):t.startBlock=[e.start]:"inline"===e.level&&(t.startInline?t.startInline.push(e.start):t.startInline=[e.start]))}"childTokens"in e&&e.childTokens&&(t.childTokens[e.name]=e.childTokens)})),n.extensions=t),e.renderer){const t=this.defaults.renderer||new _e(this.defaults);for(const n in e.renderer){if(!(n in t))throw new Error(`renderer '${n}' does not exist`);if(["options","parser"].includes(n))continue;const s=n,i=e.renderer[s],r=t[s];t[s]=(...e)=>{let n=i.apply(t,e);return!1===n&&(n=r.apply(t,e)),n||""}}n.renderer=t}if(e.tokenizer){const t=this.defaults.tokenizer||new ye(this.defaults);for(const n in e.tokenizer){if(!(n in t))throw new Error(`tokenizer '${n}' does not exist`);if(["options","rules","lexer"].includes(n))continue;const s=n,i=e.tokenizer[s],r=t[s];t[s]=(...e)=>{let n=i.apply(t,e);return!1===n&&(n=r.apply(t,e)),n}}n.tokenizer=t}if(e.hooks){const t=this.defaults.hooks||new Ce;for(const n in e.hooks){if(!(n in t))throw new Error(`hook '${n}' does not exist`);if(["options","block"].includes(n))continue;const s=n,i=e.hooks[s],r=t[s];Ce.passThroughHooks.has(n)?t[s]=e=>{if(this.defaults.async)return Promise.resolve(i.call(t,e)).then((e=>r.call(t,e)));const n=i.call(t,e);return r.call(t,n)}:t[s]=(...e)=>{let n=i.apply(t,e);return!1===n&&(n=r.apply(t,e)),n}}n.hooks=t}if(e.walkTokens){const t=this.defaults.walkTokens,s=e.walkTokens;n.walkTokens=function(e){let n=[];return n.push(s.call(this,e)),t&&(n=n.concat(t.call(this,e))),n}}this.defaults={...this.defaults,...n}})),this}setOptions(e){return this.defaults={...this.defaults,...e},this}lexer(e,t){return $e.lex(e,t??this.defaults)}parser(e,t){return Ee.parse(e,t??this.defaults)}parseMarkdown(e){return(t,n)=>{const s={...n},i={...this.defaults,...s},r=this.onError(!!i.silent,!!i.async);if(!0===this.defaults.async&&!1===s.async)return r(new Error("marked(): The async option was set to true by an extension. Remove async: false from the parse options object to return a Promise."));if(null==t)return r(new Error("marked(): input parameter is undefined or null"));if("string"!=typeof t)return r(new Error("marked(): input parameter is of type "+Object.prototype.toString.call(t)+", string expected"));i.hooks&&(i.hooks.options=i,i.hooks.block=e);const a=i.hooks?i.hooks.provideLexer():e?$e.lex:$e.lexInline,o=i.hooks?i.hooks.provideParser():e?Ee.parse:Ee.parseInline;if(i.async)return Promise.resolve(i.hooks?i.hooks.preprocess(t):t).then((e=>a(e,i))).then((e=>i.hooks?i.hooks.processAllTokens(e):e)).then((e=>i.walkTokens?Promise.all(this.walkTokens(e,i.walkTokens)).then((()=>e)):e)).then((e=>o(e,i))).then((e=>i.hooks?i.hooks.postprocess(e):e)).catch(r);try{i.hooks&&(t=i.hooks.preprocess(t));let e=a(t,i);i.hooks&&(e=i.hooks.processAllTokens(e)),i.walkTokens&&this.walkTokens(e,i.walkTokens);let n=o(e,i);return i.hooks&&(n=i.hooks.postprocess(n)),n}catch(e){return r(e)}}}onError(e,t){return n=>{if(n.message+="\nPlease report this to https://github.com/markedjs/marked.",e){const e="<p>An error occurred:</p><pre>"+we(n.message+"",!0)+"</pre>";return t?Promise.resolve(e):e}if(t)return Promise.reject(n);throw n}}};function Le(e,t){return Te.parse(e,t)}Le.options=Le.setOptions=function(e){return Te.setOptions(e),Le.defaults=Te.defaults,v(Le.defaults),Le},Le.getDefaults=function(){return{async:!1,breaks:!1,extensions:null,gfm:!0,hooks:null,pedantic:!1,renderer:null,silent:!1,tokenizer:null,walkTokens:null}},Le.defaults=k,Le.use=function(...e){return Te.use(...e),Le.defaults=Te.defaults,v(Le.defaults),Le},Le.walkTokens=function(e,t){return Te.walkTokens(e,t)},Le.parseInline=Te.parseInline,Le.Parser=Ee,Le.parser=Ee.parse,Le.Renderer=_e,Le.TextRenderer=Se,Le.Lexer=$e,Le.lexer=$e.lex,Le.Tokenizer=ye,Le.Hooks=Ce,Le.parse=Le,Le.options,Le.setOptions,Le.use,Le.walkTokens,Le.parseInline,Ee.parse,$e.lex;const Re={};class Pe{constructor({useTransition:e=!0,placement:t,offset:n,contentSelector:s,$edgeEle:i,$triggerEle:r,text:a,hideDelay:o,popoverClass:c}){if(this.placement=t,this.useTransition=e,this.offset=n,this.hideDelay=o,this.popoverClass=c,this.$triggerEle=r,this.$edgeEle=i,a){const e=document.createElement("div");e.classList.add("tooltip-text"),e.innerHTML=a,this.$content=e}else Re[s]=Re[s]||(0,x.hX)(i.$qs(s)),this.$content=Re[s].cloneNode(!0);this.$popover=null,this.isShow=!1}async show(e){if(this.isShow)return;x.x0.stack.push(this),this.$popover||this.initPopover(),this.$edgeEle.appendChild(this.$popover),this.$popover.appendChild(this.$content),this.setPopoverStyle(this.$popover),await(0,x.j1)();const t=()=>{e&&e(),this.$popover.removeEventListener("transitionend",t)};this.$popover.addEventListener("transitionend",t),(0,x.Yl)(this.$popover,!0),this.OutsideUnbind=(0,x.xD)(this.$popover,(()=>{x.x0.currentModal&&x.x0.currentModal>this.$popover.style.zIndex||(this.hide(),this.OutsideUnbind())})),this.isShow=!0,this.hideDelay&&setTimeout((()=>{this.hide()}),this.hideDelay)}async setPopoverStyle(e){const t=this.$edgeEle.getBoundingClientRect(),n=this.$triggerEle.getBoundingClientRect(),{top:s,left:i,placement:r}=(0,x.Au)(t,n,e.offsetWidth,e.offsetHeight,this.offset,this.placement);[e.style.transformOrigin,e.style.transform]={top:["bottom","scaleY(0.01)"],bottom:["top","scaleY(0.01)"],left:["right","scaleX(0.01)"],right:["left","scaleX(0.01)"]}[r],e.style.top=`${s}px`,e.style.left=`${i}px`,e.style.zIndex=x.x0.global,x.x0.global+=1,await(0,x.j1)(),this.useTransition&&(e.style.transition="all .25s,opacity .2s")}initPopover(){const e=document.createElement("div");e.classList.add("chat_popover"),this.popoverClass&&e.classList.add(this.popoverClass),this.$popover=e}async hide(){if(!this.isShow)return;const e=()=>{(0,x.hX)(this.$content),(0,x.hX)(this.$popover),x._c.emit(b.kZ.poperHide),this.OutsideUnbind(),this.$popover.removeEventListener("transitionend",e),this.isShow=!1};(0,x.Ab)(x.x0.stack,this),this.$popover.addEventListener("transitionend",e),(0,x.Yl)(this.$popover,!1)}}class Ae{constructor(e){this.chatView=e,this.$thread=e.$chatView.$qs(".thread"),this.$threadMsgs=this.$thread.$qs(".thread-messages"),this.isHovering=!1,this.Popover=new Pe({contentSelector:".msg-command",$edgeEle:this.$thread}),this.clickedMsg="",this.wrapFunction(),this.bindMsgEvents(),this.bindThreadHover(),this.bindPromptToggle(),this.bindDotClick(),this.bindThreadScroll()}wrapFunction(){this.scrollToBottom=(0,x.P2)(this.scrollToBottom,300)}bindMsgEvents(){const{chatEngine:e,eleInput:t}=this.chatView;t.on(b.ng.send,(e=>{this.appendElByMessage({content:e,role:b.HB.user})})),e.on(b.TH.load,(e=>{this.renderThread(e)})),e.on(b.TH.create,(e=>{e.role!==b.HB.user&&this.appendElByMessage(e)})),e.on(b.TH.append,(e=>{this.replaceCurrentElContent(e)})),e.on(b.TH.replace,(e=>{this.replaceCurrentElContent(e)}))}bindThreadHover(){this.$thread.addEventListener("mouseenter",(()=>{this.isHovering=!0})),this.$thread.addEventListener("mouseleave",(()=>{this.isHovering=!1}))}bindPromptToggle(){this.chatView.elePrompt.on(b.ng.promptToggle,(e=>{this.$thread.style.height=`calc(100% - ${247+e}px)`}))}bindDotClick(){this.$threadMsgs.addEventListener("click",(e=>{e.target.classList.contains("dot")&&(this.clickedMsg=e.target.previousSibling.textContent,this.showMsgCommand(e.target))}))}showMsgCommand(e){this.Popover=new Pe({placement:(0,x.oq)(".message",e).classList.contains("sent")?"left":"right",contentSelector:".msg-command",$edgeEle:this.$thread,$triggerEle:e,offset:0}),this.Popover.show(),this.bindCommand()}bindCommand(){this.Popover.$content.addEventListener("click",(async e=>{const t=e.target.getAttribute("command"),{chatData:n}=this.chatView;try{await n.handleMsgCommand(t,this.clickedMsg,this.chatView.chatEngine),(0,x.hJ)("success")}catch(e){(0,x.hJ)(`${t}:${e.message}`,!0)}}))}bindThreadScroll(){let e=!1;this.$threadMsgs.addEventListener("scroll",(()=>{this.Popover.isShow&&!1===e&&(e=!0,setTimeout((()=>{this.Popover.hide(),e=!1}),100))}))}renderThread(e){this.$threadMsgs.innerHTML="",e.forEach((e=>{this.appendElByMessage(e)}))}appendElByMessage(e){if(e.role===b.HB.system)return;let t=e.content,n="",s=!1;const i=t.match(/<think>(.*?)<\/think>/s);i&&(n=i[1].trim(),t=t.replace(/<think>(.*?)<\/think>/s,"").trim(),s=!0),e.role===b.HB.user&&t.trim().startsWith("<")||(t=Le.parse(t));const r=s?'<button class="think-toggle-button">Show Thinking</button>':"",a=s?`<div class="think-content" style="display: none;">${Le.parse(n)}</div>`:"",o=`<div class='message ${"user"===e.role?"sent":"received"}'>${r}${a}<div class='message-text'>${t}</div><button  class='bx bx-dots-vertical-rounded dot icon-action'></button></div>`,c=(0,x.yh)(o);if(this.$threadMsgs.appendChild(c),s){const e=c.$qs(".think-toggle-button"),t=c.$qs(".think-content");e.addEventListener("click",(()=>{const n="none"===t.style.display;t.style.display=n?"block":"none",e.textContent=n?"Hide Thinking":"Show Thinking"}))}return this.scrollToBottom(),c}scrollToBottom(){this.$threadMsgs.scrollTop=1e11}getCurrentMsgDom(){const{children:e}=this.$threadMsgs;return e[e.length-1]}replaceCurrentElContent(e){const t=this.getCurrentMsgDom();let n=e.content,s="",i=!1;const r=n.match(/<think>(.*?)<\/think>/s);r&&(s=r[1].trim(),n=n.replace(/<think>(.*?)<\/think>/s,"").trim(),i=!0),e.role===b.HB.user&&n.trim().startsWith("<")?t.$qs(".message-text").innerHTML=n:t.$qs(".message-text").innerHTML=Le.parse(n);let a=t.$qs(".think-toggle-button"),o=t.$qs(".think-content");if(i)if(a)o.innerHTML=Le.parse(s);else{const e='<button class="think-toggle-button">Show Thinking</button>',n=`<div class="think-content" style="display: none;">${Le.parse(s)}</div>`;t.children[0].insertAdjacentHTML("beforebegin",e+n),a=t.$qs(".think-toggle-button"),o=t.$qs(".think-content"),a.addEventListener("click",(()=>{const e="none"===o.style.display;o.style.display=e?"block":"none",a.textContent=e?"Hide Thinking":"Show Thinking"}))}else a&&(0,x.hX)(a),o&&(0,x.hX)(o);this.isHovering||this.scrollToBottom()}removeCurrentEl(){const e=this.getCurrentMsgDom();(0,x.hX)(e)}}class Me extends w.Z{constructor(e){super(),this.view=e,this.$chatView=e.$chatView,this.$resizer=this.$chatView.$qs(".resizer"),this.bindResize()}bindResize(){let e=-1,t=-1,n=-1;const s=s=>{s.stopPropagation(),(0,x.rs)((()=>{n=t+(e-s.x),this.$chatView.style.width=`${n}px`}),"handleMousemove")},i=e=>{e.stopPropagation(),document.body.style.cursor=null,this.view.chatData.setOption(b.PV.viewWidth,n),document.removeEventListener("mousemove",s,!0),document.removeEventListener("mouseup",i)};this.$resizer.addEventListener("mousedown",(n=>{n.preventDefault(),n.stopPropagation(),document.body.style.cursor="e-resize",e=n.x,t=Number(window.getComputedStyle(this.$chatView).width.replace("px","")),document.addEventListener("mousemove",s,!0),document.addEventListener("mouseup",i)}),!0)}}class qe extends w.Z{constructor(e){super(),this.chatView=e,this.$stop=e.$chatView.$qs(".thread_op_stop"),this.$stop.addEventListener("click",(()=>{e.chatEngine.cancelGenerating()})),this.$regenerate=e.$chatView.$qs(".thread_op_regenerate"),this.$regenerate.addEventListener("click",(()=>{e.chatEngine.regenerate()})),this.bindEngineEvents()}bindEngineEvents(){this.chatView.chatEngine.on(b.TH.setStatus,(e=>{this.toggleStopGenerating([b.S2.generating,b.S2.fetching].includes(e)),this.toggleRegenerate([b.S2.cancel,b.S2.failed].includes(e))}))}toggleStopGenerating(e){(0,x.WB)(this.$stop,e)}toggleRegenerate(e){(0,x.WB)(this.$regenerate,e)}}class Oe extends w.Z{constructor(e){super(),this.chatView=e,this.$userInput=e.$chatView.$qs(".input-area"),this.$sendBtn=e.$chatView.$qs(".operate_send"),this.engineStatus=b.S2.none,this.bindInput(),this.bindSendMessage(),this.bindDependEvents()}bindInput(){this.$userInput.addEventListener("input",(()=>{this.setBtnStyle()}))}bindDependEvents(){x._c.on(b.kZ.poperHide,(()=>{this.$userInput.focus()})),this.chatView.chatEngine.on(b.TH.setStatus,(e=>{this.enableUserInput(e!==b.S2.failed),this.handleMsgStatus(e)})),this.chatView.elePrompt.on(b.ng.promptToggle,(()=>{this.setBtnStyle()})),this.chatView.on([b.ng.viewShow],(()=>{this.$userInput.focus()}))}handleMsgStatus(e){this.engineStatus=e,this.setBtnStyle()}async setBtnStyle(){const e=(0,x.qr)(this.engineStatus)||this.engineStatus===b.S2.none;let t="";if(this.$userInput.focus(),e){const{msgEngine:e}=await this.getParsedMsg();if(!e)return this.$sendBtn.classList.add("freezed"),void this.$sendBtn.setAttribute("title","Type a message");this.$sendBtn.classList.remove("freezed"),t="Send(Enter to send, Shift+Enter to break line)"}else this.$sendBtn.classList.add("freezed"),t=this.engineStatus===b.S2.failed?"Regenerating is worth a try":"Wait a moment";this.$sendBtn.setAttribute("title",t)}bindSendMessage(){const e=async()=>{if(this.checkShortcut())return;var{msgView:e,msgEngine:t}=await this.getParsedMsg();const n=/{{activeNote}}/g;if(n.test(t))try{const{engine:s,view:i}=await this.chatView.chatData.getActiveNoteContent();t=t.replace(n,s),e=e.replace(n,i)}catch(e){console.error(e)}(0,x.fF)(e,t),t&&this.chatView.chatEngine.isAvailable()&&(this.emit(b.ng.send,e),this.chatView.chatEngine.requestCompletion({userInput:t}),this.clearInput())};this.$sendBtn.addEventListener("click",e.bind(this)),this.$userInput.addEventListener("keydown",(t=>{"Enter"!==t.key||t.shiftKey||(t.preventDefault(),e.call(this))}))}checkShortcut(){const e=this.$userInput.value.trim(),t={"/p":b.ng.p,"/c":b.ng.c,"/h":b.ng.h}[e];if(t)return this.clearInput(),this.chatView.emit(t),!0}async getParsedMsg(){const e=this.chatView.elePrompt.$getParsedPromt(),t=this.$userInput.value,n=(0,x.YU)(t);if((0,x.fF)(e,t,n),!e)return{msgEngine:t.trim(),msgView:n.trim()};let s=e,i=e;const r=/{{message}}/g,a=/{{activeNote}}/g;if(a.test(e))try{const{engine:e,view:t}=await this.chatView.chatData.getActiveNoteContent();s=s.replace(a,e),i=i.replace(a,t),(0,x.fF)(s,i)}catch(e){console.error(e)}return r.test(e)&&(s=s.replace(r,t),i=i.replace(r,n)),{msgEngine:s.trim(),msgView:i.trim()}}enableUserInput(e){this.$userInput.disabled=!e}clearInput(){this.$userInput.value=""}}const Ie={[b.S2.none]:"Ready",[b.S2.fetching]:"Thinking...",[b.S2.generating]:"Typing...",[b.S2.success]:"On standby",[b.S2.failed]:b.S2.failed,[b.S2.cancel]:b.S2.cancel};class Be{constructor(e){this.chatView=e,this.$status=e.$chatView.$qs(".operate_status"),e.chatEngine.on(b.TH.setStatus,(e=>{this.handleMsgStatus(e)}))}handleMsgStatus(e){const t=Ie[e];this.$status.textContent=t}handleDataStatus(e){const{status:t,key:n,value:s}=e;t===b.f5.success?this.$status.textContent="":this.$status.textContent=`${t}: ${n} - ${s}`}}class Ne{constructor(e){this.view=e;const t=e.$chatView.$qs(".header_face");e.on(b.ng.viewShow,(()=>{this.refreshFace(t,e.options)})),this.handleCheckUpdates(t,e.options)}async handleCheckUpdates(e,t){if(t.checkUpdates)try{const t="https://api.github.com/repos/soulsands/trilium-chat/releases/latest",n=await fetch(t),s=await n.json(),i=s?.tag_name;i>(window.__triliumChatVersion||"1.1.1")&&(e.classList.add("dot"),e.setAttribute("title","New version found, click to download"),e.addEventListener("click",(async e=>{e.preventDefault();try{const e=s.assets[0].browser_download_url;window.open(e)}catch(e){console.error(e)}}),!0))}catch(e){console.error(e)}}refreshFace(e,t){const n=t[b.PV.faces],s=t[b.PV.colors],i=(0,x.MX)(n),r=(0,x.MX)(s);e.classList.forEach((t=>{/bx.+/.test(t)&&e.classList.remove(t)})),e.style.color=r,e.classList.add(i)}}class He{constructor(e){this.chatView=e,this.$collapse=e.$chatView.$qs(".header_hide"),this.bindCollapse()}bindCollapse(){this.$collapse.addEventListener("click",(()=>{this.chatView.hideView()}))}}class ze{constructor({type:e="dialog",$content:t,$chatView:n}){this.type=e,this.wrapperClassName={popup:"content_wrapper_popup",dialog:"content_wrapper_dialog"}[e],this.$content=(0,x.hX)(t),this.$chatView=n,this.$modal=null,this.isShow=!1}async show(e){if(!this.isShow){if(this.$modal||this.initModal(),x.x0.global+=1,this.$modal.style.zIndex=x.x0.global,x.x0.currentModal=x.x0.global,this.$chatView.appendChild(this.$modal),(0,x.WB)(this.$modal,!0),this.$contentWrapper.classList.add(this.wrapperClassName),"popup"!==this.type){const{offsetWidth:t,offsetHeight:n}=this.$contentWrapper,{offsetLeft:s,offsetTop:i}=this.$chatView,{left:r,width:a,top:o,height:c}=e.target.getBoundingClientRect();this.$contentWrapper.style.left=r+a/2-s-t/2+"px",this.$contentWrapper.style.top=o+c/2-i-n/2+"px"}await(0,x.j1)(),(0,x.Yl)(this.$mask,!0),(0,x.Yl)(this.$contentWrapper,!0),this.isShow=!0,x.x0.stack.push(this)}}initModal(){this.$modal=(0,x.yh)('<div class="chat_modal">\n<div class="modal_mask"></div>\n<div class="content_wrapper"></div>\n</div>'),this.$mask=this.$modal.$qs(".modal_mask"),this.$contentWrapper=this.$modal.$qs(".content_wrapper"),this.$contentWrapper.appendChild(this.$content),this.bindClick()}bindClick(){this.$mask.addEventListener("click",(()=>{this.hide()})),this.$contentWrapper.addEventListener("click",(()=>{}))}async hide(){if(!this.isShow)return;const e=()=>{(0,x.WB)(this.$modal,!1),this.$contentWrapper.style.left="initial",this.$contentWrapper.style.top="initial",x._c.emit(b.kZ.poperHide),this.$contentWrapper.classList.remove(this.wrapperClassName),(0,x.hX)(this.$modal),this.isShow=!1,x.x0.currentModal=null,this.$mask.removeEventListener("transitionend",e)};(0,x.Ab)(x.x0.stack,this),this.$mask.addEventListener("transitionend",e),(0,x.Yl)(this.$mask,!1),(0,x.Yl)(this.$contentWrapper,!1)}}class Ve extends w.Z{constructor(e){super(),this.chatView=e,this.$content=e.$chatView.$qs(".content_select_history"),this.Modal=new ze({type:"popup",$content:this.$content,$chatView:e.$chatView}),this.$showBtn=e.$chatView.$qs(".operate_btn_history"),this.$historyLabel=this.$content.$qs(".select_count"),this.$num=this.$content.$qs(".select_num"),this.$closeBtn=this.$content.$qs(".select_close"),this.$search=this.$content.$qs(".select_search_input"),this.$list=this.$content.$qs(".select_list"),this.$recordTpl=(0,x.hX)(this.$content.$qs(".select_item")),this.records=[],this.bindEvents()}hide(){this.Modal.hide()}bindEvents(){this.chatView.on(b.ng.h,(async()=>{this.show()})),this.$showBtn.addEventListener("click",(async()=>{this.show()})),this.$closeBtn.addEventListener("click",(()=>{this.hide()})),this.$historyLabel.addEventListener("click",(()=>{this.chatView.chatData.goHistorys()})),this.$search.addEventListener("input",(e=>{this.renderSearch(e.target.value)})),this.$list.addEventListener("click",(e=>{const t=(0,x.oq)("[data-id]",e.target);if(t){const n=this.records.find((e=>e.id===t.dataset.id));if(e.target.classList.contains("bx-edit-alt"))return void this.chatView.chatData.goHistory(t.dataset.id);this.hide(),this.chatView.chatEngine.loadThread(n)}}))}async show(){this.Modal.show(),this.loadHistory(),await(0,x._v)(300),this.$search.focus()}async loadHistory(){const e=await this.chatView.chatData.getRecords();this.records=Object.keys(e).map((t=>({id:t,...e[t]})));const t=[...this.records.filter((e=>e.favor)).sort(this.sortByStamp),...this.records.filter((e=>!e.favor)).sort(this.sortByStamp)];this.renderCount(this.records.length),this.renderList(t)}sortByStamp(e,t){const n=e.list[e.list.length-1];return t.list[t.list.length-1].stamp-n.stamp}renderCount(e){this.$num.textContent=e}renderList(e){this.$list.innerHTML="";const t=document.createDocumentFragment();e.forEach((e=>{const n=e.list.find((e=>e.role===b.HB.assistant)),s=e.list[e.list.length-1],i=this.$recordTpl.cloneNode(!0);if((0,x.Rh)(i,(()=>{this.hide(),this.chatView.chatEngine.loadThread(e)})),e.favor){const e=document.createElement("div");e.classList.add("favor"),i.appendChild(e)}i.setAttribute("data-id",e.id),i.$qs(".item_title").textContent=e.title||e.originTitle,i.$qs(".item_stamp").textContent=(0,x.Sy)(s.stamp);const r=i.$qs(".item_preview");r.setAttribute("title",n.content),r.textContent=n.content,t.appendChild(i)})),this.$list.appendChild(t)}renderSearch(e){const t=this.records.filter((t=>t.list.some((t=>(0,x.UR)(t.content).includes((0,x.UR)(e))))));this.renderList(t)}}class De extends w.Z{constructor(e){super(),this.$newBtn=e.$chatView.$qs(".operate_btn_new"),this.$newBtn.addEventListener("click",(()=>{e.chatEngine.newChat()}))}}class Ze extends w.Z{constructor(e){super(),this.chatView=e,this.$showBtn=e.$chatView.$qs(".operate_btn_command"),this.popover=new Pe({placement:"top",contentSelector:".content_command",$edgeEle:e.$chatView,$triggerEle:this.$showBtn,offset:6}),this.$content=this.popover.$content,e.on(b.ng.c,(()=>{this.show()})),this.bindShowClick(),this.bindCommand(),this.checkAutoSave()}checkAutoSave(){this.chatView.options.autoSave&&(this.$content.$qs("[command=history]").style.display="none")}bindShowClick(){this.$showBtn.addEventListener("click",(()=>{this.show()}))}async show(){this.popover.show((()=>{this.$content.$qs(".command_item").focus()}))}bindCommand(){this.$content.querySelectorAll(".command_item").forEach((e=>{const t=()=>{const t=e.getAttribute("command");this.excuteCommand(t)};e.addEventListener("click",(()=>{t()})),(0,x.Rh)(e,(()=>{t()}))}))}async hide(){this.popover.hide()}async excuteCommand(e){const{chatEngine:t,chatData:n}=this.chatView;try{(0,x.$k)(t),await n.handleCommand(e,t),(0,x.hJ)("success")}catch(t){(0,x.hJ)(`${e}:${t.message}`,!0)}}}class je extends w.Z{constructor({$content:e,$chatView:t,title:n,saveText:s="Save",cancelText:i="Cancel"}){super(),this.$wrapper=document.createElement("div"),this.$wrapper.innerHTML=`<div class="form_wrapper">\n        <div class="form_wrapper_top flex-center-between">\n            <div class="wapper_title">${n}</div>\n            <div class="wapper_close bx bx-x icon-action"></div>\n        </div>\n        <div class="wrapper_content"></div>\n        <div class="wrapper_op">\n            <button class="chat_button wrapper_btn_cancel">${i}</button>\n            <button class="chat_button wrapper_btn_save ml-1">${s}</button>\n        </div>\n    </div>`,this.$content=e,this.$chatView=t,this.$save=this.$wrapper.$qs(".wrapper_btn_save"),this.$wrapper.$qs(".wrapper_content").appendChild(e),t.appendChild(this.$wrapper),this.$inputs=Array.from(this.$content.querySelectorAll("[name]")),this.modal=new ze({type:"dialog",$content:this.$wrapper,$chatView:t}),this.flagObj=null,this.bindEvents()}bindEvents(){this.$wrapper.$qs(".wapper_close").addEventListener("click",(()=>{this.emit(b.ng.formCancel)})),this.$save.addEventListener("click",(()=>{const e=Array.from(this.$content.querySelectorAll("[name]"));try{const t=e.reduce(((e,t)=>{if(e[t.name]=t.value,!t.value)throw((e,t,n,s="right")=>{new Pe({placement:s,text:e,$edgeEle:n,$triggerEle:t,offset:0,hideDelay:1e3}).show()})("no empty",this.$save,this.$chatView,"top"),new Error;return e}),{});this.emit(b.ng.formSave,t,this.flagObj)}catch(e){console.error(e)}})),this.$wrapper.$qs(".wrapper_btn_cancel").addEventListener("click",(()=>{this.emit(b.ng.formCancel)}))}show(e,{title:t,formData:n={},flagObj:s}={}){t&&(this.$wrapper.$qs(".wapper_title").textContent=t),this.$inputs.forEach(((e,t)=>{0===t&&setTimeout((()=>{e.focus()}),200),e.value=n[e.name]||""})),this.flagObj=s,this.modal.show(e)}hide(){this.enable(!0),this.modal.hide()}enable(e){this.$wrapper.$qs(".wrapper_btn_save").disabled=!e,this.$wrapper.$qs(".wrapper_btn_cancel").disabled=!e}}class Fe extends w.Z{constructor(e){super(),this.chatView=e,this.$promptContent=e.$chatView.$qs(".prompt_content"),this.$showBtn=e.$chatView.$qs(".operate_btn_prompt"),this.Popover=new Pe({placement:"top",contentSelector:".content_select_prompt",$edgeEle:e.$chatView,$triggerEle:this.$showBtn,offset:6,popoverClass:"popover_prompt"}),this.$content=this.Popover.$content,this.$count=this.$content.$qs(".select_count"),this.$countNum=this.$count.$qs(".select_num"),this.$addBtn=this.$content.$qs(".select_add"),this.$closeBtn=this.$content.$qs(".select_close"),this.$search=this.$content.$qs(".select_search_input"),this.$list=this.$content.$qs(".select_list"),this.$promptTpl=(0,x.hX)(this.$content.$qs(".select_item")),this.$contentForm=e.$chatView.$qs(".content_prompt_form"),this.ModalForm=new je({$content:this.$contentForm,$chatView:e.$chatView,title:"Add prompt template"}),this.prompts=[],this.bindEvents(),this.currentPrompt=null}async hide(){this.Popover.hide()}bindEvents(){this.chatView.on(b.ng.p,(()=>{this.show()})),this.$showBtn.addEventListener("click",(async()=>{this.show()})),this.bindContentEvents(),this.bindListEvents(),this.bindFormEvents()}show(){this.Popover.show((()=>{this.$search.focus()})),this.loadPrompts()}bindContentEvents(){this.$promptContent.$qs(".prompt_content_close").addEventListener("click",(()=>{this.$promptContent.style.height="0px",(0,x.WB)(this.$promptContent,!1),this.clearContent(),this.emit(b.ng.promptToggle,0)}))}clearContent(){this.currentPrompt=null,this.$text.innerHTML=""}bindListEvents(){this.$count.addEventListener("click",(()=>{window.open("https://prompts.chat/#using-promptschat")})),this.$addBtn.addEventListener("click",(async e=>{this.ModalForm.show(e,{title:"Add prompt template"})})),this.$closeBtn.addEventListener("click",(()=>{this.hide()})),this.$search.addEventListener("input",(e=>{this.renderSearch(e.target.value)})),this.$list.addEventListener("click",(async e=>{const t=(0,x.oq)("[data-id]",e.target);if(t){const n=this.prompts.find((e=>e.id===t.dataset.id));let s="select";if(e.target.classList.contains("bx-edit-alt")?s="edit":e.target.classList.contains("bx-trash")&&(s="delete"),"edit"===s)return void this.ModalForm.show(e,{title:"Edit prompt template",formData:{"prompt-name":n.name,"prompt-content":n.content},flagObj:n});if("delete"===s)return await this.chatView.chatData.deletePrompt(n),void this.loadPrompts();(0,x.fF)(n),this.handlePromptContent(n),this.hide()}}))}async handlePromptContent(e){this.currentPrompt=e,(0,x.WB)(this.$promptContent,!0),this.renderContent(e)}async renderContent(e){this.$text=this.$promptContent.$qs(".prompt_content_text"),this.$text.innerHTML=(0,x.Xj)(e.content),await(0,x.j1)(),this.$promptContent.style.height=`${this.$text.offsetHeight+40}px`,this.emit(b.ng.promptToggle,this.$text.offsetHeight+40)}bindFormEvents(){this.ModalForm.on(b.ng.formSave,(async(e,t)=>{if((0,x.fF)(t),this.ModalForm.enable(!1),t){const n={...t,name:e["prompt-name"],content:e["prompt-content"]};await this.chatView.chatData.updatePrompt(n),t.id===this.currentPrompt.id&&(this.currentPrompt=n,this.renderContent(n))}else{const t={name:e["prompt-name"],content:e["prompt-content"],id:Date.now().toString()};await this.chatView.chatData.createPrompt(t)}this.ModalForm.hide(),this.loadPrompts()})),this.ModalForm.on(b.ng.formCancel,(()=>{this.ModalForm.hide()}))}async loadPrompts(){this.prompts=(await this.chatView.chatData.getPrompts()||[]).sort(((e,t)=>t.order-e.order)),this.renderCount(this.prompts.length),this.renderList(this.prompts)}renderCount(e){this.$countNum.textContent=e}renderList(e){this.$list.innerHTML="";const t=document.createDocumentFragment();e.forEach((e=>{const n=this.$promptTpl.cloneNode(!0);(0,x.Rh)(n,(()=>{this.handlePromptContent(e),this.hide()})),n.setAttribute("data-id",e.id),n.setAttribute("title",e.content),n.$qs(".item_title").textContent=e.name,t.appendChild(n)})),this.$list.appendChild(t)}renderSearch(e){const t=this.prompts.filter((t=>(0,x.UR)(t.name).includes((0,x.UR)(e))||(0,x.UR)(t.content).includes((0,x.UR)(e))));this.renderList(t)}$getParsedPromt(){return this.currentPrompt?(0,x.jN)(this.$promptContent,this.currentPrompt.content):""}}class We{constructor(e){e.$chatView.$qs(".operate_btn_option").addEventListener("click",(()=>{e.chatData.goOptions()}))}}class Ue extends w.Z{constructor({options:e,chatData:t,chatEngine:n}){super(),this.options=e,this.chatData=t,this.chatEngine=n,this.appendEleToHost(),this.$chatView=null,this.initSkeleton(),this.activateElements(),this.initViewWidth(),this.bindListeners()}initSkeleton(e="body"){const t=document.$qs(e);this.$chatView=(0,x.yh)('<div class="chat-wrapper"><div class="resizer"></div><div class="header"><div class="header_left flex-center"><a class="link flex-center no-arrow" href="https://github.com/soulsands/trilium-chat" target="_blank"><i class="header_face bx icon-view" title="home"></i></a></div><div class="header_right"><button title="hide" class="header_hide bx bx-minus icon-action"></button></div></div><div class="thread"><div class="thread-messages"></div><button class="thread_op thread_op_stop">Stop generating</button> <button class="thread_op thread_op_regenerate">Retry/Regenerate Output</button><div class="msg-command"><div class="command_item" command="copy" title="Copy">Copy</div><div class="command_item" command="insert" title="Insert to caret">Insert</div><div class="command_item" command="append" title="Append to active notet">Append</div><div class="command_item" command="set" title="Set to active note">Set</div><div class="command_item" command="child" title="Save to new child">Child</div></div></div><div class="prompt_content"><div class="prompt_content_close flex-row-reverse"><i class="bx bx-x icon-action"></i></div><div class="prompt_content_text"></div></div><div class="operate no-shrink"><div class="operate_top flex-center-between"><div class="operate_top_left flex-center"><button class="operate_btn operate_btn_new chat_button">New Chat</button> <button class="operate_btn operate_btn_prompt bx bx-book-bookmark icon-action" title="Prompt"></button> <button class="operate_btn operate_btn_command bx bx-terminal icon-action" title="Command"></button><div class="operate_btn operate_btn_history bx bx-history icon-action" title="History"></div></div><div class="operate_top_right"><button class="operate_btn operate_btn_option bx bx-cog icon-action" title="Options"></button></div></div><div class="operate_input"><textarea class="input-area bd-main" placeholder="Send a message..."></textarea> <i title="Send(Enter to send, Shift+Enter to break line)" class="operate_send bx bx-paper-plane icon-action"></i></div><div class="operate_bottom flex-row-reverse"><div class="operate_status"></div></div></div><div class="content_select content_select_prompt"><div class="select_top flex-center-between"><div class="flex-center"><div class="select_count pointer">Prompt(<span class="select_num">0</span>)</div><button class="ml-2 select_add bx bx-plus icon-action"></button></div><button class="select_close bx bx-chevron-down icon-action"></button></div><div class="select_search bd-main flex-center"><i class="bx bx-search"></i> <input class="select_search_input" placeholder="Search"/></div><div class="select_list"><div class="select_item" tabindex="0"><div class="item_top"><div class="item_title one-line"></div><div class="item_op no-shrink"><i class="bx bx-edit-alt icon-action"></i> <i class="bx bx-trash icon-action"></i></div></div>\x3c!-- <div class="item_preview one-line"></div> --\x3e</div></div></div><form class="content_prompt_form"><label>Prompt Name:</label> <input class="prompt_input bd-main" placeholder="Name your prompt" name="prompt-name"/> <label class="mt-1">Prompt Content:</label> <textarea class="prompt_input bd-main prompt_input_content" placeholder="Paste or input content here" type="tex" name="prompt-content"></textarea></form><div class="content_select content_select_history"><div class="select_top flex-center-between"><div class="select_count pointer">History(<span class="select_num"></span>)</div><div class="select_close bx bx-chevron-down icon-action"></div></div><div class="select_search bd-main flex-center"><i class="bx bx-search"></i> <input class="select_search_input" placeholder="Search"/></div><div class="select_list"><div class="select_item" tabindex="0"><div class="flex-center-between item_top"><div class="item_title one-line"></div><div class="item_stamp no-shrink"></div></div><div class="flex-center-between item_down"><div class="item_preview one-line"></div><div class="item_op no-shrink"><i class="bx bx-edit-alt icon-action"></i></div></div></div></div></div><div class="content_command"><div class="command_title">Commands</div><div class="command_list"><div class="command_item" command="copy" tabindex="0">Copy thread</div><div class="command_item" command="history" tabindex="0">Save to history</div><div class="command_item" command="favor" tabindex="0">Favor in history</div><div class="command_item" command="unfavor" tabindex="0">Unfavor in history</div><div class="command_item" command="set" tabindex="0">Set to active note</div><div class="command_item" command="append" tabindex="0">Append to active note</div><div class="command_item" command="child" tabindex="0">Save to new child</div></div></div></div>'),t.appendChild(this.$chatView)}appendEleToHost(){this.appendToggleBtn()}appendToggleBtn(){(0,x.de)()}activateElements(){this.elePrompt=new Fe(this),this.eleInput=new Oe(this),this.eleResizer=new Me(this),this.eleThread=new Ae(this),this.eleGenerate=new qe(this),this.eleStatus=new Be(this),this.eleFace=new Ne(this),this.eleCollapse=new He(this),this.eleHistory=new Ve(this),this.eleNewChat=new De(this),this.eleCommand=new Ze(this),new We(this)}initViewWidth(){this.$chatView.style.width=`${this.options[b.PV.viewWidth]}px`}bindListeners(){this.$chatView.addEventListener("keydown",x.$O),this.bindShortcut()}bindShortcut(){(0,x.de)()}showView(){this.emit(b.ng.viewShow),this.$chatView.classList.add(b.f1)}hideView(){this.emit(b.ng.viewHide),this.$chatView.classList.remove(b.f1)}isViewShow(){return this.$chatView.classList.contains(b.f1)}toggleView(){this.isViewShow()?this.hideView():this.showView()}}},302:(e,t,n)=>{n(257),n(977)},323:(e,t,n)=>{n.d(t,{Z:()=>b});var s=n(379),i=n.n(s),r=n(795),a=n.n(r),o=n(569),c=n.n(o),l=n(565),h=n.n(l),p=n(216),d=n.n(p),u=n(589),g=n.n(u),m=n(447),f={};f.styleTagTransform=g(),f.setAttributes=h(),f.insert=c().bind(null,"head"),f.domAPI=a(),f.insertStyleElement=d(),i()(m.Z,f),m.Z&&m.Z.locals&&m.Z.locals;var w=n(977);class b extends w.Z{appendToggleBtn(){const e=class extends api.NoteContextAwareWidget{isEnabled(){return!0}constructor(e){super(),this.options=e}doRender(){this.$widget=$('<div class="chat-toggle-wrapper flex-row-reverse"><button class="button-widget bx icon-action"\n      data-toggle="tooltip"\n      title=""></button></div>');const e=this.$widget.find(".button-widget");e.attr("data-placement","bottom"),e.tooltip({html:!0,title:"Chat",trigger:"hover"}),e.addClass("bx-message-square-dots"),e.on("click",this.options.onClick),this.$btn=e,super.doRender()}},t=new e({onClick:()=>{t.$btn.tooltip("hide"),this.toggleView()}}),n=$(".title-bar-buttons");n.length?n.prepend(t.render()):$(".tab-row-filler").prepend(t.render())}bindShortcut(){const{toggle:e,hide:t}=this.options.shortcut;api.bindGlobalShortcut(e,(()=>{this.toggleView()})),api.bindGlobalShortcut(t,(()=>{this.hideView()}))}}},257:(e,t,n)=>{n.d(t,{GD:()=>w,HB:()=>s,HT:()=>m,O2:()=>f,PV:()=>d,S2:()=>l,TH:()=>a,WN:()=>g,bs:()=>o,cQ:()=>p,cT:()=>u,f1:()=>h,f5:()=>c,kZ:()=>r,ng:()=>i,t$:()=>b});const s={system:"system",user:"user",assistant:"assistant",error:"error"},i={viewShow:"viewShow",viewHide:"viewHide",formSave:"formSave",formCancel:"formCancel",promptToggle:"promptToggle",send:"send",p:"p",c:"c",h:"h"},r={poperHide:"ph"},a={create:"create",append:"append",replace:"replace",cancel:"cancel",setStatus:"setStatus",load:"load"},o={setStatus:"setStatus"},c={optionSyncing:"optionSyncing",success:"success",failed:"failed"},l={none:"none",fetching:"Fetching information for task.",generating:"Generating information for task.",success:"Successfully completed task.",failed:"Failed, view the console for more information. (ctrl + shift + i)",cancel:"Canceled task."},h="show",p="fadein",d={viewWidth:"viewWidth",faces:"faces",colors:"colors"},u={CHAT_OPTIONS:"CHAT_OPTIONS",CHAT_PROMPTS:"CHAT_PROMPTS",HISTORY_LABEL:"CHAT_HISTORY_ID",HISTORY_HOME_LABEL:"CHAT_HISTORY_HOME"},g={viewWidth:400,engine:"ChatGpt",apiKey:"MISSING_ENV_VAR".APIKEY,requestUrls:{completion:"https://api.groq.com/openai/v1/chat/completions"},engineOptions:{model:"deepseek-r1-distill-llama-70b",max_tokens:2500,temperature:.3,top_p:1,presence_penalty:.5,frequency_penalty:.5,stream:!0,n:1},shortcut:{toggle:"Alt+Q",hide:"Esc"},faces:["bx-smile","bx-wink-smile","bx-face","bx-happy-alt","bx-cool","bx-laugh","bx-upside-down"],colors:["var(--muted-text-color)"],autoSave:!0,systemPrompt:"",checkUpdates:!0},m=[{id:"official-0",name:"translate",content:"Translate the following content to {{language:English|Chinese|Czech}} language: \n{{message}}",order:0},{id:"official-1",name:"translateNote",content:"Translate the following content to {{language:English|Chinese|Czech}} language: \n{{activeNote}}",order:1},{id:"official-2",name:"summarizeNote",content:"Summarize the following content: \n{{activeNote}}",order:2}],f="NOT SUPPORTED",w="Only support text/code",b="No thread"},225:(e,t,n)=>{n.a(e,(async(e,t)=>{try{var s=n(926),i=(n(302),n(323)),r=(n(300),n(0)),a=n(257),o=n(655);class e{constructor(){this.init()}async init(){const e=this.setChatData(),t=await e.initOptions();await e.initPrompts();const n=this.getEngine(t);this.setView({chatData:e,options:t,chatEngine:n}),n.newChat()}setChatData(){return this.chatData=new r.Z,this.chatData.on(a.bs.setStatus,(e=>{this.chatView.eleStatus.handleDataStatus(e)})),this.chatData}getEngine(e){let t;return"chatgpt"===e.engine.toLowerCase()&&(t=new s.Z(e)),t.on(a.TH.setStatus,(n=>{e.autoSave&&this.chatData.handleMsgStatus(n,t)})),t}async setView(e){const t=i.Z;this.chatView=new t(e)}}Element.prototype.$qs=Element.prototype.querySelector,Document.prototype.$qs=Document.prototype.querySelector,await(0,o.j1)(),window._triliumChat=new e,t()}catch(e){t(e)}}),1)},655:(e,t,n)=>{n.d(t,{rs:()=>$,Ab:()=>M,Rh:()=>x,Au:()=>G,tY:()=>q,xD:()=>m,oq:()=>l,RV:()=>H,JG:()=>X,fF:()=>A,YU:()=>W,$k:()=>B,jN:()=>d,_c:()=>U,yh:()=>u,qr:()=>I,$O:()=>v,Yo:()=>O,j1:()=>T,Xj:()=>p,MX:()=>L,hX:()=>c,hJ:()=>N,_v:()=>C,Xg:()=>V,qT:()=>z,P2:()=>_,_y:()=>S,de:()=>E,Sy:()=>Y,UR:()=>P,Yl:()=>o,WB:()=>a,IO:()=>R,x0:()=>w});var s=n(605),i=n(257);function r(e,t,n){e.classList.toggle(n,t)}function a(e,t){r(e,t,i.f1)}function o(e,t){r(e,t,i.cQ)}function c(e){if(e.parentElement)return e.parentElement.removeChild(e)}function l(e,t){return t?.matches?t.matches(e)?t:l(e,t.parentNode):null}const h=/{{([^}]+):([^}]+)}}/g,p=e=>{let t,n=e;for(;null!==(t=h.exec(n));){const e=t[0],s=`<select name="${t[1].trim()}">${t[2].split("|").map((e=>e.trim())).map((e=>`<option value="${e}">${e}</option>`)).join("")}<select>`;n=n.replace(e,s)}return h.lastIndex=0,n},d=(e,t)=>{let n=t;return Array.from(e.querySelectorAll("select")).forEach((e=>{const t=h.exec(n)[0];n=n.replace(t,e.value)})),h.lastIndex=0,n},u=e=>{const t=document.createElement("template");return t.innerHTML=e,t.content.lastChild},g=new Map;function m(e,t){return g.set(e,t),function(){g.delete(e)}}function f(e){g.forEach(((t,n)=>{n.contains(e.target)||t.call(n,e)}))}m.globalClick=f,document.addEventListener("click",f);const w={global:0,currentModal:null,stack:[]},b=new WeakSet,x=(e,t)=>{b.add(e),e.addEventListener("enter",t)},k=new WeakSet,v=e=>{if("Enter"===e.key){if(!b.has(e.target))return;return e.stopImmediatePropagation(),void e.target.dispatchEvent(new CustomEvent("enter"))}if("Escape"===e.key){const t=w.stack.pop();if(t)return e.stopImmediatePropagation(),void t.hide();k.has(e.target)&&(e.stopImmediatePropagation(),e.target.dispatchEvent(new CustomEvent("esc")))}},y={};function $(e,t="default"){return!y[t]&&(y[t]=!0,window.requestAnimationFrame((n=>{y[t]=!1,e(n)})),!0)}function _(e,t){let n=0;return function(...s){const i=(new Date).getTime();i-n>=t&&(e.apply(this,s),n=i)}}function S(e){throw new Error(e)}function E(e){e||S("should implement in child classes")}async function C(e){await new Promise((t=>{setTimeout(t,e)}))}async function T(){await C(10)}const L=e=>e[Math.floor(Math.random()*e.length)];function R(e){return`<p>${e}</p>`}function P(e){return e.toLowerCase()}function A(...e){console.warn(...e)}const M=(e,t)=>{const n=e.findIndex((e=>e===t));-1!==n&&e.splice(n,1)};function q(e,t){let n=!1;return Object.keys(e).forEach((e=>{e in t||(n=!0)})),n}function O(e,t){const n={...t};return Object.keys(e).forEach((s=>{s in t&&(n[s]=e[s])})),n}const I=e=>[i.S2.cancel,i.S2.success].includes(e),B=e=>{const t=e.thread.find((e=>e.role===i.HB.user));return t||S(i.t$),t.content},N=(e,t)=>{t?api.showError(e,3e3):api.showMessage(e)};function H(e){if("string"!=typeof e)throw new TypeError("should be string");const t=e.match(/[^\n]+\n?/g).reduce(((e,t,n,s)=>(/```/.test(t)?(e.inCode=!e.inCode,e.codeStr&&(e.strs.push(`<pre><code>${e.codeStr}</code></pre>`),e.codeStr="")):e.inCode?e.codeStr+=t:e.strs.push(`<p>${t.replace("\n","")}</p>`),n===s.length-1&&e.inCode&&e.strs.push(`<pre><code>${e.codeStr}</code></pre>`),e)),{inCode:!1,strs:[],codeStr:""});return A(t),t.strs.join("")}function z(e,t){let n=e.map((e=>`role: ${e.role}\n${e.content}`)).join("\n");return t&&(n=e.map((e=>`<p>role: ${e.role}</p>${H(e.content)}`)).join("")),n||S("no content"),n}const V=e=>e.slice(0,50),{replace:D}="",Z=/[&<>'"]/g,j={"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"},F=e=>j[e],W=e=>D.call(e,Z,F),U=new s.Z;function Y(e){const t=e=>Math.floor(e),n=t((new Date-new Date(e))/1e3);let s=t(n/31536e3);return s>=1?`${s} year${1===s?"":"s"} ago`:(s=t(n/2592e3),s>=1?`${s} month${1===s?"":"s"} ago`:(s=t(n/86400),s>=1?`${s} day${1===s?"":"s"} ago`:(s=t(n/3600),s>=1?`${s} hour${1===s?"":"s"} ago`:(s=t(n/60),s>=1?`${s} minute${1===s?"":"s"} ago`:0===n?"just now":`${t(n)} second${1===t(n)?"":"s"} ago`))))}function G(e,t,n,s,i,r){let a,o;switch(r){case"top":default:a=t.left+t.width/2-n/2,o=t.top-s-i;break;case"left":a=t.left-n-i,o=t.top+t.height/2-s/2;break;case"right":a=t.left+t.width+i,o=t.top+t.height/2-s/2;break;case"bottom":a=t.left+t.width/2-n/2,o=t.top+t.height+i}a-=e.left,o-=e.top;const c=e.width,l=e.height;if(a<0){if(a=0,"left"===r)return G(e,t,n,s,i,"right")}else if(a+n>c&&(a=c-n,"right"===r))return G(e,t,n,s,i,"left");return o<0?o=0:o+s>l&&(o=l-s),{left:a,top:o,placement:r}}const X=e=>{navigator.clipboard.writeText(e)}}},r={};function a(e){var t=r[e];if(void 0!==t)return t.exports;var n=r[e]={id:e,exports:{}};return i[e](n,n.exports,a),n.exports}e="function"==typeof Symbol?Symbol("webpack queues"):"__webpack_queues__",t="function"==typeof Symbol?Symbol("webpack exports"):"__webpack_exports__",n="function"==typeof Symbol?Symbol("webpack error"):"__webpack_error__",s=e=>{e&&!e.d&&(e.d=1,e.forEach((e=>e.r--)),e.forEach((e=>e.r--?e.r++:e())))},a.a=(i,r,a)=>{var o;a&&((o=[]).d=1);var c,l,h,p=new Set,d=i.exports,u=new Promise(((e,t)=>{h=t,l=e}));u[t]=d,u[e]=e=>(o&&e(o),p.forEach(e),u.catch((e=>{}))),i.exports=u,r((i=>{var r;c=(i=>i.map((i=>{if(null!==i&&"object"==typeof i){if(i[e])return i;if(i.then){var r=[];r.d=0,i.then((e=>{a[t]=e,s(r)}),(e=>{a[n]=e,s(r)}));var a={};return a[e]=e=>e(r),a}}var o={};return o[e]=e=>{},o[t]=i,o})))(i);var a=()=>c.map((e=>{if(e[n])throw e[n];return e[t]})),l=new Promise((t=>{(r=()=>t(a)).r=0;var n=e=>e!==o&&!p.has(e)&&(p.add(e),e&&!e.d&&(r.r++,e.push(r)));c.map((t=>t[e](n)))}));return r.r?l:a()}),(e=>(e?h(u[n]=e):l(d),s(o)))),o&&(o.d=0)},a.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return a.d(t,{a:t}),t},a.d=(e,t)=>{for(var n in t)a.o(t,n)&&!a.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),a.nc=void 0,a(225)})();